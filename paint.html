<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroDraw PRO v2.2 - Network Fix</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --border-color: #333333;
            --accent-color: #2196F3;
            
            /* --- ÜVEG HATÁS --- */
            --glass-bg: rgba(20, 20, 20, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            --glass-blur: 15px;
            
            --modal-bg: #1a1a1a;
            --input-field-bg: #252525;
            --btn-hover: rgba(255, 255, 255, 0.15);
            --run-color: #2196F3;
            --system-msg-color: #888;
            --p2p-msg-color: #d19a66;
        }

        body.light-mode {
            --bg-color: #f5f5f7;
            --text-color: #333333;
            --border-color: #d1d1d1;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --modal-bg: #ffffff;
            --input-field-bg: #e6e6e6;
            --btn-hover: rgba(0, 0, 0, 0.05);
            --run-color: #1976D2;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; }

        /* --- CANVAS LAYERS --- */
        #canvas-wrapper {
            position: relative; width: 100%; height: 100%; background: var(--bg-color); overflow: hidden; cursor: crosshair;
        }
        .drawing-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; /* Alapból átenged, csak az aktív fogad */
        }
        .drawing-layer.active { pointer-events: auto; }
        #background-layer { z-index: 0; background-color: #000000; transition: background-color 0.3s; }

        /* --- LEBEGŐ PANELEK (GLASS) --- */
        .floating-panel {
            position: absolute; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border); padding: 10px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; z-index: 100; box-shadow: var(--glass-shadow);
        }
        
        /* Eszköztár (Bal) */
        .toolbar-left { top: 100px; left: 20px; }

        /* Rétegkezelő (Jobb) */
        .layer-panel-right { top: 100px; right: 20px; width: 200px; max-height: 60vh; }

        .tool-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.05); color: var(--text-color); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .tool-btn:hover, .tool-btn.active { background: var(--accent-color); color: white; border-color: transparent; }
        
        /* Színpaletta */
        .color-palette { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .color-swatch { width: 30px; height: 30px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.active { border-color: white; box-shadow: 0 0 5px var(--accent-color); }
        input[type="color"] { -webkit-appearance: none; padding: 0; height: 36px; width: 36px; cursor: pointer; border: 2px solid var(--border-color); background: transparent; border-radius: 8px; overflow: hidden; }

        /* Réteg lista elemek */
        .layer-list { display: flex; flex-direction: column-reverse; gap: 5px; overflow-y: auto; flex: 1; } /* Reverse: új réteg felül */
        .layer-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-size: 13px; }
        .layer-item.active { border-color: var(--accent-color); background: rgba(33, 150, 243, 0.1); }
        .layer-item .layer-name { flex: 1; margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .layer-actions button { padding: 2px; background: transparent; border: none; color: #ff5555; opacity: 0.6; cursor: pointer; }
        .layer-actions button:hover { opacity: 1; }

        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; border-radius: 2px; background: #444; outline: none; margin-top: 5px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--accent-color); cursor: pointer; }

        /* LIVE jelző */
        #live-indicator { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(80, 250, 123, 0.1); color: #50fa7b; border: 1px solid #50fa7b; padding: 2px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; pointer-events: none; z-index: 50; display: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        /* --- HEADER --- */
        .header-wrapper { position: fixed; top: 25px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; z-index: 1000; pointer-events: none; }
        .glass-bubble { pointer-events: auto; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 100px; padding: 6px 10px; display: flex; align-items: center; gap: 10px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .glass-bubble:hover { transform: translateY(-2px); box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.8); }
        .app-title { font-weight: 700; font-size: 14px; padding-left: 15px; padding-right: 10px; letter-spacing: 0.5px; color: var(--text-color); display: flex; align-items: center; gap: 8px; }
        .vertical-divider { width: 1px; height: 24px; background-color: rgba(255,255,255,0.2); margin: 0 5px; }
        button.icon-btn { background: transparent; border: none; color: var(--text-color); width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; position: relative;}
        button.icon-btn:hover { background: var(--btn-hover); transform: scale(1.1); }
        /* Disabled state for undo/redo */
        button.icon-btn:disabled { opacity: 0.3; cursor: default; transform: none; }
        button.icon-btn:disabled:hover { background: transparent; }
        
        #user-btn { cursor: pointer; font-size:12px; opacity:0.8; margin-right:5px; padding: 6px 12px; border-radius: 20px; transition: background 0.2s; font-weight:600; letter-spacing:0.5px; }
        #user-btn:hover { background: var(--btn-hover); opacity: 1; }

        /* --- DROPDOWN --- */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { opacity: 0; visibility: hidden; position: absolute; right: 0; top: 50px; background-color: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); min-width: 280px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.6); border-radius: 12px; border: 1px solid var(--glass-border); z-index: 2000; overflow: hidden; transition: all 0.2s ease-in-out; transform: translateY(-10px) scale(0.98); padding: 10px; cursor: default; }
        .dropdown:hover .dropdown-content { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
        .menu-item { color: var(--text-color); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-size: 13px; transition: background 0.2s; cursor: pointer; border-radius: 6px; }
        .menu-item:hover { background-color: var(--accent-color); color: white; }

        /* P2P UI */
        .user-chip-container { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; margin-bottom: 10px; }
        .user-chip { background: rgba(255, 255, 255, 0.1); padding: 6px 10px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid transparent; }
        .user-chip.self { border-color: var(--accent-color); }
        .user-chip .username { font-weight: 600; }
        .user-chip .kick-btn { background: transparent; border: none; color: #ff5555; cursor: pointer; display: flex; align-items: center; padding: 2px; border-radius: 50%; }

        /* --- MAIN CONTAINER (Full screen canvas) --- */
        .main-container { display: flex; height: 100vh; width: 100%; }
        .editor-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); min-width: 0; position: relative; }
        
        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10001; backdrop-filter: blur(8px); justify-content: center; align-items: center; }
        .modal { background: var(--modal-bg); width: 350px; padding: 25px; border-radius: 24px; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        .modal button { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; float: right; margin-top: 15px; font-weight: 600; }
        .modal input { width: 100%; padding: 12px; background: var(--input-field-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 8px; margin-bottom: 10px; outline: none;}
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 9998; display: none; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .gear { width: 60px; height: 60px; fill: var(--accent-color); animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <svg class="gear" viewBox="0 0 512 512"><path d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>
        <div style="margin-top:20px; color:#666">Mentés...</div>
    </div>

    <div class="header-wrapper">
        <div class="glass-bubble left-bubble">
            <div class="app-title">
                <img src="aeroICON.png" style="height: 24px; margin-right: 5px;" onerror="this.style.display='none'">
                AeroDraw PRO v2
            </div>
            <div class="vertical-divider"></div>
            
            <button class="icon-btn" id="btn-undo" onclick="undoLastAction()" title="Visszavonás"><span class="material-icons">undo</span></button>
            <button class="icon-btn" id="btn-redo" onclick="redoLastAction()" title="Visszavonás visszavonása"><span class="material-icons">redo</span></button>
            <div class="vertical-divider" style="height: 16px; margin: 0 2px; opacity: 0.5;"></div>
            
            <button class="icon-btn" onclick="clearCurrentLayer()" title="Réteg Törlése"><span class="material-icons">delete</span></button>
            <button class="icon-btn" onclick="downloadImage()" title="Mentés képként"><span class="material-icons">image</span></button>
        </div>

        <div class="glass-bubble right-bubble">
            <div id="user-btn" onclick="openLoginModal()">Log in</div>
            <div class="dropdown">
                <button class="icon-btn" title="Közös Rajzolás (P2P)" onclick="resetP2PUI()">
                    <span class="material-icons">group</span>
                </button>
                <div class="dropdown-content">
                    <h4 style="margin:0 0 10px 0; border-bottom:1px solid #444; padding-bottom:5px;">Közös Rajzolás</h4>
                    <div id="connect-ui">
                        <div style="font-size:11px; opacity:0.7; margin-bottom:5px">Válassz egy csatornát:</div>
                        <select id="channel-select" style="width:100%; padding:8px; background:var(--input-field-bg); border:1px solid var(--border-color); color:var(--text-color); border-radius:4px; margin-bottom:10px; font-family:'Inter'">
                            <option value="1">1. Csatorna (Alpha)</option>
                            <option value="2">2. Csatorna (Beta)</option>
                            <option value="3">3. Csatorna (Gamma)</option>
                        </select>
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:10px;">
                            <span style="font-size:11px; opacity:0.7;">Max létszám:</span>
                            <input type="number" id="room-size-limit" min="2" max="10" value="3" style="width:60px; padding:4px; font-size:11px; margin-bottom:0;">
                        </div>
                        <div style="font-size:10px; color:#ff5555; margin-bottom:10px; display:none;" id="login-warning">Jelentkezz be a csatlakozáshoz!</div>
                        <div style="display:flex; gap:5px;">
                            <button onclick="startAsHost()" style="flex:1; padding:8px; background:var(--run-color); color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">HOST</button>
                            <button onclick="joinAsGuest()" style="flex:1; padding:8px; background:#50fa7b; color:#222; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">JOIN</button>
                        </div>
                    </div>
                    <div id="disconnect-ui" style="display:none;">
                        <div style="background:rgba(80, 250, 123, 0.1); color:#50fa7b; padding:8px; border-radius:4px; margin-bottom:10px; text-align:center; font-size:12px;">
                            <span class="material-icons" style="font-size:12px; vertical-align:middle;">link</span> Kapcsolódva
                        </div>
                        <div id="active-users-list" class="user-chip-container"></div>
                        <button onclick="disconnectPeer()" style="width:100%; padding:8px; background:#ff5555; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Szétkapcsolás</button>
                    </div>
                    <div id="p2p-log" style="font-size:10px; color:#888; margin-top:10px; font-style:italic;">Offline</div>
                </div>
            </div>
            <div class="dropdown">
                <button class="icon-btn" title="Felhő Mentés">
                    <span class="material-icons">cloud_queue</span>
                </button>
                <div class="dropdown-content">
                    <a class="menu-item" onclick="handleDriveSave()"><span class="material-icons">save</span> Mentés Drive-ra (Kép)</a>
                </div>
            </div>
            <button class="icon-btn" onclick="toggleTheme()" title="Téma"><span class="material-icons">dark_mode</span></button>
            <button class="icon-btn" onclick="openSettings()" title="Beállítások"><span class="material-icons">settings</span></button>
        </div>
    </div>

    <div class="main-container">
        <div class="editor-container">
            <div id="live-indicator">● LIVE P2P</div>
            
            <div id="canvas-wrapper">
                <canvas id="background-layer" class="drawing-layer"></canvas>
                </div>

            <div class="floating-panel toolbar-left">
                <div style="text-align:center; font-size:10px; opacity:0.7;">Vászon Háttér</div>
                <input type="color" id="canvas-bg-picker" value="#000000" title="Vászon háttérszíne" onchange="changeCanvasBg(this.value)">
                
                <div style="width:100%; height:1px; background:var(--border-color); margin:5px 0;"></div>
                
                <div class="color-palette">
                    <div class="color-swatch active" style="background:#ffffff" onclick="pickColor('#ffffff', this)"></div>
                    <div class="color-swatch" style="background:#000000" onclick="pickColor('#000000', this)"></div>
                    <div class="color-swatch" style="background:#ff5555" onclick="pickColor('#ff5555', this)"></div>
                    <div class="color-swatch" style="background:#50fa7b" onclick="pickColor('#50fa7b', this)"></div>
                    <div class="color-swatch" style="background:#2196F3" onclick="pickColor('#2196F3', this)"></div>
                    <div class="color-swatch" style="background:#f1fa8c" onclick="pickColor('#f1fa8c', this)"></div>
                </div>
                <input type="color" id="pen-color-input" value="#ffffff" title="Egyedi szín">
                
                <div style="width:100%; height:1px; background:var(--border-color); margin:5px 0;"></div>
                
                <button class="tool-btn active" id="btn-brush" onclick="setTool('brush')" title="Ecset"><span class="material-icons">brush</span></button>
                <button class="tool-btn" id="btn-eraser" onclick="setTool('eraser')" title="Radír"><span class="material-icons">auto_fix_normal</span></button>
                
                <div style="padding:0 5px;">
                    <label style="font-size:9px; opacity:0.7;">Méret</label>
                    <input type="range" id="pen-width" min="1" max="50" value="5">
                </div>
            </div>

            <div class="floating-panel layer-panel-right">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border-color); padding-bottom:5px;">
                    <span style="font-weight:600; font-size:12px;">RÉTEGEK</span>
                    <button class="icon-btn" style="width:24px; height:24px;" onclick="addNewLayer()" title="Új réteg">+</button>
                </div>
                <div id="layer-list-container" class="layer-list">
                    </div>
            </div>

        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-top:0; color:var(--text-color)">Beállítások</h3>
            <p style="font-size:12px; opacity:0.7">Jelenleg nincs további beállítás.</p>
            <button onclick="document.getElementById('settingsModal').style.display='none'">Bezárás</button>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-top:0; color:var(--text-color)">Bejelentkezés</h3>
            <input type="text" id="loginNameInput" placeholder="Felhasználónév...">
            <button onclick="performLogin()">Belépés</button>
            <button onclick="document.getElementById('loginModal').style.display='none'" style="background:transparent; margin-right:10px; color:var(--text-color)">Mégse</button>
        </div>
    </div>

    <script>
        // --- KONFIGURÁCIÓ ---
        const CLIENT_ID = '138100233309-v575n23j2b6pdek9t9clvkg3immlkrdi.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyAfC2viqoOsVVjcShnqY2rrRsxdV7WHMEg'; 
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // --- PEER CONFIG (Anti-Firewall) ---
        const peerConfig = {
            debug: 1,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
                ]
            }
        };

        // --- GLOBÁLIS VÁLTOZÓK (Rajz & Rétegek) ---
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const bgLayer = document.getElementById('background-layer');
        const bgCtx = bgLayer.getContext('2d');
        
        let layers = []; // { id, canvas, ctx, name }
        let activeLayerId = null;
        let layerCounter = 1;
        
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentTool = 'brush';
        let penColor = '#ffffff';
        let penWidth = 5;
        let canvasBgColor = '#000000';

        // --- UNDO / REDO RENDSZER ---
        const MAX_HISTORY = 30; // Maximum ennyi lépést jegyzünk meg a memória kímélése érdekében
        let undoStack = [];
        let redoStack = [];

        function saveStateForUndo() {
            if (!activeLayerId) return;
            const activeLayer = layers.find(l => l.id === activeLayerId);
            if (!activeLayer) return;

            // Mentjük az aktív réteg jelenlegi állapotát (ImageData) és az ID-ját
            const currentState = {
                layerId: activeLayerId,
                imageData: activeLayer.ctx.getImageData(0, 0, activeLayer.canvas.width, activeLayer.canvas.height)
            };

            undoStack.push(currentState);

            // Ha túllépjük a limitet, a legrégebbit eldobjuk
            if (undoStack.length > MAX_HISTORY) {
                undoStack.shift();
            }

            // Új műveletnél a Redo stack mindig törlődik
            redoStack = [];
            updateUndoRedoButtons();
        }

        function undoLastAction() {
            if (undoStack.length === 0) return;

            // 1. Kivesszük az utolsó állapotot a veremből
            const previousState = undoStack.pop();
            const targetLayer = layers.find(l => l.id === previousState.layerId);

            if (targetLayer) {
                // 2. Mielőtt visszaállítjuk, elmentjük a JELENLEGI állapotot a Redo stackbe
                const redoState = {
                    layerId: previousState.layerId,
                    imageData: targetLayer.ctx.getImageData(0, 0, targetLayer.canvas.width, targetLayer.canvas.height)
                };
                redoStack.push(redoState);

                // 3. Visszaállítjuk a régit
                targetLayer.ctx.putImageData(previousState.imageData, 0, 0);
            } else {
                // Ha a réteg időközben törlődött, rekurzívan próbálkozunk a következővel
                console.warn("A réteg már nem létezik, ugrás a következő visszavonásra.");
                undoLastAction();
            }
            updateUndoRedoButtons();
        }

        function redoLastAction() {
            if (redoStack.length === 0) return;

            // 1. Kivesszük a Redo állapotot
            const nextState = redoStack.pop();
            const targetLayer = layers.find(l => l.id === nextState.layerId);

            if (targetLayer) {
                // 2. Elmentjük a mostani állapotot az Undo stackbe (hogy újra visszavonható legyen)
                const undoState = {
                    layerId: nextState.layerId,
                    imageData: targetLayer.ctx.getImageData(0, 0, targetLayer.canvas.width, targetLayer.canvas.height)
                };
                undoStack.push(undoState);

                // 3. Visszaállítjuk a jövőbeli állapotot
                targetLayer.ctx.putImageData(nextState.imageData, 0, 0);
            }
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            document.getElementById('btn-undo').disabled = undoStack.length === 0;
            document.getElementById('btn-redo').disabled = redoStack.length === 0;
            // Opacity kezelése CSS-ben van a :disabled szelektorral
        }

        // --- RÉTEGKEZELÉS ---
        function initLayers() {
            // Kezdeti réteg létrehozása
            addNewLayer("Réteg 1");
            resizeCanvases();
            updateUndoRedoButtons(); // Init gombok
        }

        function createLayerCanvas(id) {
            const cvs = document.createElement('canvas');
            cvs.id = `layer-${id}`;
            cvs.className = 'drawing-layer';
            // Eseménykezelők az új canvasra
            cvs.addEventListener('mousedown', startDraw);
            cvs.addEventListener('mousemove', draw);
            cvs.addEventListener('mouseup', stopDraw);
            cvs.addEventListener('mouseout', stopDraw);
             // Touch events
            cvs.addEventListener('touchstart', (e) => { e.preventDefault(); cvs.dispatchEvent(new MouseEvent('mousedown', { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY })); });
            cvs.addEventListener('touchmove', (e) => { e.preventDefault(); cvs.dispatchEvent(new MouseEvent('mousemove', { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY })); });
            cvs.addEventListener('touchend', (e) => { cvs.dispatchEvent(new MouseEvent('mouseup', {})); });
            return cvs;
        }

        function addNewLayer(nameOverride) {
            const id = layerCounter++;
            const name = nameOverride || `Réteg ${id}`;
            const newCanvas = createLayerCanvas(id);
            canvasWrapper.appendChild(newCanvas);
            
            const layerObj = { id: id, canvas: newCanvas, ctx: newCanvas.getContext('2d'), name: name };
            layers.push(layerObj);
            setActiveLayer(id);
            updateLayerListUI();
            resizeCanvases(); // Ensure size is correct
            
            if(isHost) broadcastLayerStructure(); // P2P szinkron
        }

        function deleteLayer(id) {
            if(layers.length <= 1) { alert("Legalább egy rétegnek maradnia kell!"); return; }
            const index = layers.findIndex(l => l.id === id);
            if(index > -1) {
                // Törlés előtt ürítjük a history-t, mert az ID-k bezavarhatnak (vagy bonyolultabb logika kellene)
                // Egyszerűsítés: törlés után tiszta lappal indul a history, hogy ne legyen hiba
                undoStack = undoStack.filter(state => state.layerId !== id);
                redoStack = redoStack.filter(state => state.layerId !== id);
                updateUndoRedoButtons();

                canvasWrapper.removeChild(layers[index].canvas);
                layers.splice(index, 1);
                // Ha az aktívat töröltük, válasszuk ki az előzőt (vagy a legelsőt)
                if(id === activeLayerId) {
                    setActiveLayer(layers[Math.max(0, index - 1)].id);
                }
                updateLayerListUI();
                if(isHost) broadcastLayerStructure(); // P2P szinkron
            }
        }

        function setActiveLayer(id) {
            activeLayerId = id;
            layers.forEach(l => {
                if(l.id === id) {
                    l.canvas.classList.add('active');
                } else {
                    l.canvas.classList.remove('active');
                }
            });
            updateLayerListUI();
        }

        function updateLayerListUI() {
            const container = document.getElementById('layer-list-container');
            container.innerHTML = "";
            layers.forEach(layer => {
                const item = document.createElement('div');
                item.className = `layer-item ${layer.id === activeLayerId ? 'active' : ''}`;
                item.onclick = () => setActiveLayer(layer.id);
                item.innerHTML = `
                    <span class="material-icons" style="font-size:16px; opacity:0.7;">layers</span>
                    <span class="layer-name">${layer.name}</span>
                    <div class="layer-actions">
                        <button onclick="event.stopPropagation(); deleteLayer(${layer.id})" title="Törlés">✕</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function clearCurrentLayer() {
            const activeLayer = layers.find(l => l.id === activeLayerId);
            if(activeLayer) {
                // MENTÉS TÖRLÉS ELŐTT
                saveStateForUndo();
                activeLayer.ctx.clearRect(0, 0, activeLayer.canvas.width, activeLayer.canvas.height);
                broadcastDrawEvent({ type: 'clear_layer', layerId: activeLayerId });
            }
        }

        function changeCanvasBg(color) {
            canvasBgColor = color;
            bgCtx.fillStyle = color;
            bgCtx.fillRect(0, 0, bgLayer.width, bgLayer.height);
            document.getElementById('canvas-bg-picker').value = color;
            if(isHost || (conn && conn.open)) broadcastDrawEvent({ type: 'bg_change', color: color });
        }

        // --- RAJZOLÓ LOGIKA ---
        function resizeCanvases() {
            const width = canvasWrapper.offsetWidth;
            const height = canvasWrapper.offsetHeight;
            
            // Háttér réteg
            bgLayer.width = width; bgLayer.height = height;
            changeCanvasBg(canvasBgColor); // Újrarajzolás

            // Rajz rétegek
            layers.forEach(layer => {
                // Mentés átméretezés előtt
                const tempCvs = document.createElement('canvas'); tempCvs.width = layer.canvas.width; tempCvs.height = layer.canvas.height; tempCvs.getContext('2d').drawImage(layer.canvas,0,0);
                layer.canvas.width = width; layer.canvas.height = height;
                layer.ctx.drawImage(tempCvs, 0, 0); // Visszatöltés
            });
            
            // Átméretezéskor érdemes törölni a history-t, mert a képméretek nem fognak egyezni
            undoStack = [];
            redoStack = [];
            updateUndoRedoButtons();
        }
        window.addEventListener('resize', resizeCanvases);

        function startDraw(e) {
            if(!activeLayerId) return;
            
            // MENTÉS RAJZOLÁS ELŐTT (Undo funkcióhoz)
            // Csak akkor mentünk, ha új vonalat kezdünk
            saveStateForUndo();

            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing || !activeLayerId) return;
            const activeLayer = layers.find(l => l.id === activeLayerId);
            if(!activeLayer) return;

            const newX = e.offsetX; const newY = e.offsetY;
            const colorToUse = currentTool === 'eraser' ? 'rgba(0,0,0,1)' : penColor; // Radír trükk: feketével festünk, majd kompozittal törlünk
            
            // Helyi rajzolás
            drawLine(activeLayer.ctx, lastX, lastY, newX, newY, colorToUse, penWidth, currentTool === 'eraser');
            
            // P2P Küldés
            broadcastDrawEvent({
                type: 'draw', layerId: activeLayerId,
                x0: lastX, y0: lastY, x1: newX, y1: newY,
                color: colorToUse, width: penWidth, isEraser: currentTool === 'eraser'
            });

            [lastX, lastY] = [newX, newY];
        }

        function stopDraw() { isDrawing = false; }

        function drawLine(targetCtx, x0, y0, x1, y1, color, width, isEraser) {
            targetCtx.beginPath(); targetCtx.moveTo(x0, y0); targetCtx.lineTo(x1, y1);
            targetCtx.strokeStyle = color; targetCtx.lineWidth = width;
            targetCtx.lineCap = 'round'; targetCtx.lineJoin = 'round';
            if(isEraser) targetCtx.globalCompositeOperation = 'destination-out';
            targetCtx.stroke();
            targetCtx.closePath();
            if(isEraser) targetCtx.globalCompositeOperation = 'source-over';
        }

        // --- UI ESEMÉNYEK ---
        function pickColor(color, element) {
            penColor = color;
            document.getElementById('pen-color-input').value = color;
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            if(currentTool === 'eraser') setTool('brush');
        }
        document.getElementById('pen-color-input').addEventListener('input', (e) => { penColor = e.target.value; document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active')); if(currentTool === 'eraser') setTool('brush'); });
        document.getElementById('pen-width').addEventListener('input', (e) => penWidth = e.target.value);
        function setTool(tool) { currentTool = tool; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-${tool}`).classList.add('active'); }

        function downloadImage() {
            // Képek összefésülése egy ideiglenes canvasra
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = bgLayer.width; tempCanvas.height = bgLayer.height;
            const tempCtx = tempCanvas.getContext('2d');
            // 1. Háttér
            tempCtx.drawImage(bgLayer, 0, 0);
            // 2. Rétegek sorban
            layers.forEach(layer => { tempCtx.drawImage(layer.canvas, 0, 0); });
            
            const link = document.createElement('a');
            link.download = `AeroDraw_Pro_${new Date().getTime()}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }

        // --- AUTH & P2P ALAPOK ---
        let currentUser=null, tokenClient, gapiInited=false, gisInited=false;
        let peer=null, conn=null, isHost=false, connectedUsers=[], maxParticipants=3;
        const ROOM_MAPPING = {"1":"adp_v2_r1","2":"adp_v2_r2","3":"adp_v2_r3"};
        
        function openLoginModal() { document.getElementById('loginModal').style.display='flex'; }
        function performLogin() { const name=document.getElementById('loginNameInput').value.trim(); if(!name)return; localStorage.setItem('saved_user',name); currentUser=name; document.getElementById('user-btn').innerText=name; document.getElementById('loginModal').style.display='none'; document.getElementById('login-warning').style.display='none'; if(gapiInited&&gisInited&&!gapi.client.getToken())tokenClient.requestAccessToken({prompt:''}); }
        function gapiLoaded(){gapi.load('client',async()=>{await gapi.client.init({apiKey:API_KEY,discoveryDocs:[DISCOVERY_DOC]});gapiInited=true;});}
        function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:(resp)=>{}});gisInited=true;}

        // --- P2P RÉTEG SZINKRONIZÁCIÓ ---
        function broadcastDrawEvent(data) {
            if(isHost) connectedUsers.forEach(u => u.conn.send(data));
            else if(conn && conn.open) conn.send(data);
        }

        function broadcastLayerStructure() {
            // Csak a Host küldi a struktúrát
            if(!isHost) return;
            const structure = layers.map(l => ({ id: l.id, name: l.name }));
            connectedUsers.forEach(u => u.conn.send({ type: 'layer_structure', layers: structure, bg: canvasBgColor }));
        }

        function sendFullSnapshot(targetConn) {
            // Háttér + Minden réteg képként
            const snapshot = { type: 'full_snapshot', bg: canvasBgColor, layers: [] };
            layers.forEach(l => {
                snapshot.layers.push({ id: l.id, image: l.canvas.toDataURL() });
            });
            targetConn.send(snapshot);
        }

        function handleP2PData(data) {
            // --- RAJZ ESEMÉNYEK ---
            if (data.type === 'draw') {
                const targetLayer = layers.find(l => l.id === data.layerId);
                if(targetLayer) drawLine(targetLayer.ctx, data.x0, data.y0, data.x1, data.y1, data.color, data.width, data.isEraser);
            }
            else if(data.type === 'clear_layer') {
                const targetLayer = layers.find(l => l.id === data.layerId);
                if(targetLayer) targetLayer.ctx.clearRect(0,0,targetLayer.canvas.width, targetLayer.canvas.height);
            }
            else if(data.type === 'bg_change') { changeCanvasBg(data.color); }

            // --- STRUKTÚRA & SNAPSHOT (Vendég fogadja) ---
            else if(data.type === 'layer_structure') {
                // Vendég oldal: Töröljük a jelenlegi rétegeket és felépítjük az újat
                canvasWrapper.innerHTML = '<canvas id="background-layer" class="drawing-layer"></canvas>';
                const newBg = document.getElementById('background-layer'); bgCtx = newBg.getContext('2d');
                layers = [];
                // Reset history vendég oldalon struktúra váltáskor
                undoStack = []; redoStack = []; updateUndoRedoButtons();
                
                changeCanvasBg(data.bg);
                data.layers.forEach(lData => {
                    const newCanvas = createLayerCanvas(lData.id);
                    canvasWrapper.appendChild(newCanvas);
                    layers.push({ id: lData.id, canvas: newCanvas, ctx: newCanvas.getContext('2d'), name: lData.name });
                });
                resizeCanvases();
                if(layers.length > 0) setActiveLayer(layers[0].id);
            }
            else if(data.type === 'full_snapshot') {
                // Képek betöltése a rétegekre
                changeCanvasBg(data.bg);
                data.layers.forEach(lData => {
                    const targetLayer = layers.find(l => l.id === lData.id);
                    if(targetLayer) {
                        const img = new Image();
                        img.onload = () => targetLayer.ctx.drawImage(img, 0, 0);
                        img.src = lData.image;
                    }
                });
            }
            // --- EGYÉB (User lista, Kick) ---
            else if(data.type==='user_list') { connectedUsers=data.users; updateActiveUsersUI(); }
            else if(data.type==='kick') { alert("Kirúgtak."); disconnectPeer(); }
        }

        // --- P2P CORE FUNKCIÓK ---
        function startAsHost() { 
            if(!currentUser){openLoginModal();return;} 
            if(peer)return; 
            isHost=true; 
            connectedUsers=[]; 
            maxParticipants=parseInt(document.getElementById('room-size-limit').value)||3; 
            
            // --- UPDATED CONFIG ---
            peer=new Peer(ROOM_MAPPING[document.getElementById('channel-select').value], peerConfig); 
            
            peer.on('open',id=>{document.getElementById('live-indicator').style.display='block';updateP2PUI(true);}); 
            peer.on('connection',c=>{if(connectedUsers.length+1>=maxParticipants){c.on('open',()=>{c.send({type:'error',message:'Tele'});setTimeout(()=>c.close(),500);});return;} c.on('data',d=>{if(d.type==='handshake'){connectedUsers.push({id:c.peer,conn:c,username:d.username}); broadcastUserList(); sendFullSnapshot(c); } else handleP2PData(d);}); c.on('close',()=>{connectedUsers=connectedUsers.filter(u=>u.id!==c.peer);broadcastUserList();updateActiveUsersUI();});}); 
        }

        function joinAsGuest() { 
            if(!currentUser){openLoginModal();return;} 
            if(peer)return; 
            isHost=false; 
            
            // --- UPDATED CONFIG ---
            peer=new Peer(null, peerConfig); 
            
            peer.on('open',()=>{conn=peer.connect(ROOM_MAPPING[document.getElementById('channel-select').value]); conn.on('open',()=>{conn.send({type:'handshake',username:currentUser}); document.getElementById('live-indicator').style.display='block';updateP2PUI(true);}); conn.on('data',handleP2PData); conn.on('close',resetP2PUI);}); 
        }

        function broadcastUserList(){if(!isHost)return; const list=connectedUsers.map(u=>({id:u.id,username:u.username})); list.unshift({id:'HOST',username:currentUser+' (HOST)'}); connectedUsers.forEach(u=>u.conn.send({type:'user_list',users:list})); updateActiveUsersUI();}
        function updateActiveUsersUI(){const c=document.getElementById('active-users-list'); c.innerHTML=`<div class="user-chip self"><span class="username">${currentUser}</span></div>`; connectedUsers.forEach(u=>{c.innerHTML+=`<div class="user-chip"><span class="username">${u.username}</span>${isHost?`<button class="kick-btn" onclick="kickUser('${u.id}')">x</button>`:''}</div>`});}
        function kickUser(id){const u=connectedUsers.find(x=>x.id===id);if(u){u.conn.send({type:'kick'});setTimeout(()=>u.conn.close(),100);}}
        function disconnectPeer(){if(isHost)connectedUsers.forEach(u=>u.conn.close());if(conn)conn.close();if(peer)peer.destroy();resetP2PUI();}
        function resetP2PUI(){peer=null;conn=null;isHost=false;connectedUsers=[];document.getElementById('live-indicator').style.display='none';updateP2PUI(false);}
        function updateP2PUI(online){document.getElementById('connect-ui').style.display=online?'none':'block';document.getElementById('disconnect-ui').style.display=online?'block':'none';document.getElementById('p2p-log').innerText=online?(isHost?"HOST ONLINE":"ONLINE"):"Offline";document.getElementById('p2p-log').style.color=online?"#50fa7b":"#888";}

        // --- DRIVE SAVE (Képként) ---
        async function handleDriveSave() { document.getElementById('loading-overlay').style.display='flex'; if(!currentUser||!gapi.client.getToken()){alert("Jelentkezz be!");document.getElementById('loading-overlay').style.display='none';return;}
            const tempCanvas=document.createElement('canvas'); tempCanvas.width=bgLayer.width; tempCanvas.height=bgLayer.height; const ctx=tempCanvas.getContext('2d'); ctx.drawImage(bgLayer,0,0); layers.forEach(l=>ctx.drawImage(l.canvas,0,0));
            tempCanvas.toBlob(async blob=>{ const meta={'name':`AeroDraw_${currentUser}_${Date.now()}.png`,'mimeType':'image/png'}; const form=new FormData(); form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'})); form.append('file',blob);
            try{await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:new Headers({'Authorization':'Bearer '+gapi.client.getToken().access_token}),body:form});alert("Mentve!");}catch(e){alert("Hiba!");} document.getElementById('loading-overlay').style.display='none'; }); }

        // UI & Egyéb
        let isDark=true; function toggleTheme(){isDark=!isDark;document.body.className=isDark?"":"light-mode";}
        function openSettings(){document.getElementById('settingsModal').style.display='flex';}
        
        // Indítás
        const savedUser = localStorage.getItem('saved_user'); if(savedUser){currentUser=savedUser;document.getElementById('user-btn').innerText=savedUser;}
        setTimeout(initLayers, 100); // Inicializálás kis késleltetéssel
    </script>
</body>
</html>
