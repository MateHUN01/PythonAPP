<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroCollage PRO v3.0 - Crop & Edit</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --workspace-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #2196F3;
            --border-color: #333;
            
            /* Glassmorphism */
            --glass-bg: rgba(20, 20, 20, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            --glass-blur: 15px;

            --btn-hover: rgba(255, 255, 255, 0.1);
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; user-select: none; }
        * { box-sizing: border-box; }

        /* --- WORKSPACE --- */
        .main-container { display: flex; height: 100vh; width: 100%; }
        
        #collage-area {
            flex: 1;
            background-color: var(--workspace-bg);
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        #collage-canvas {
            width: 800px; height: 600px;
            background: #ffffff;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
            transition: width 0.3s, height 0.3s, background 0.3s;
        }

        /* --- ITEMS --- */
        .collage-item {
            position: absolute; cursor: grab; user-select: none;
            border: 2px solid transparent; transition: border 0.1s;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }
        .collage-item.selected { border: 2px solid var(--accent-color); z-index: 1000 !important; }
        .collage-item img { width: 100%; height: 100%; object-fit: fill; pointer-events: none; } /* Fill, hogy a vágott kép kitöltse */

        .resize-handle {
            width: 12px; height: 12px; background: var(--accent-color);
            position: absolute; bottom: -6px; right: -6px;
            cursor: nwse-resize; border-radius: 50%; display: none;
            border: 1px solid white; z-index: 10;
        }
        .collage-item.selected .resize-handle { display: block; }

        /* --- MINI HUD --- */
        .mini-hud {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: var(--glass-bg); backdrop-filter: blur(10px);
            padding: 5px 10px; border-radius: 8px; border: 1px solid var(--glass-border);
            display: none; gap: 8px; z-index: 2000; white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .collage-item.selected .mini-hud { display: flex; }

        .hud-btn {
            background: transparent; border: none; color: white;
            cursor: pointer; width: 28px; height: 28px;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .hud-btn:hover { background: rgba(255,255,255,0.2); }

        /* --- CROP MODAL --- */
        #crop-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column;
        }
        .crop-container { flex: 1; padding: 20px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .crop-controls {
            height: 80px; background: #222; display: flex; align-items: center; justify-content: center; gap: 20px; border-top: 1px solid #444;
        }
        .crop-btn {
            background: #333; color: #ddd; border: 1px solid #555; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-btn.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }
        .crop-btn.action { background: var(--accent-color); border: none; color: white; }
        #image-to-crop { max-width: 100%; max-height: 80vh; display: block; }

        /* --- UI PANELS --- */
        .floating-panel {
            position: absolute; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 10px; z-index: 100;
        }
        .toolbar-left { top: 100px; left: 20px; width: 220px; }
        .section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; opacity: 0.6; margin-bottom: 5px; letter-spacing: 1px;}
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .big-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 10px; border-radius: 6px; cursor: pointer;
            font-size: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 5px;
            transition: 0.2s;
        }
        .big-btn:hover { background: var(--btn-hover); border-color: var(--accent-color); }
        .big-btn .material-icons { font-size: 20px; }
        
        input[type="file"] { display: none; }

        /* HEADER */
        .header-wrapper { position: fixed; top: 25px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; z-index: 1000; pointer-events: none; }
        .glass-bubble { pointer-events: auto; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); border-radius: 100px; padding: 6px 15px; display: flex; align-items: center; gap: 10px; }
        .app-title { font-weight: 700; font-size: 14px; color: var(--text-color); display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: transparent; border: none; color: var(--text-color); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: var(--btn-hover); }
        #user-btn { cursor: pointer; font-size:12px; opacity:0.8; margin-right:5px; padding: 6px 12px; border-radius: 20px; background: rgba(255,255,255,0.05); }

        /* DROPDOWNS & MODALS */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { opacity: 0; visibility: hidden; position: absolute; right: 0; top: 45px; background: var(--glass-bg); backdrop-filter: blur(20px); min-width: 250px; border-radius: 12px; border: 1px solid var(--glass-border); padding: 10px; transition: 0.2s; transform: translateY(-10px); }
        .dropdown:hover .dropdown-content { opacity: 1; visibility: visible; transform: translateY(0); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: #222; padding: 20px; border-radius: 12px; width: 300px; border: 1px solid #444; }
        .modal input { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: white; margin-bottom: 10px; border-radius: 4px; }
        .modal button { padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; float: right; }
        select.settings-select { width: 100%; padding: 8px; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; outline: none; }
        select.settings-select option { background: #222; color: white; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: none; justify-content: center; align-items: center; color: var(--accent-color); font-family: 'Inter'; }
    </style>
</head>
<body>

    <div id="loading-overlay">Feldolgozás...</div>

    <div class="header-wrapper">
        <div class="glass-bubble">
            <div class="app-title">
                <span class="material-icons" style="color:var(--accent-color)">dashboard_customize</span>
                AeroCollage PRO
            </div>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>
            <button class="icon-btn" onclick="saveCollage()" title="Exportálás"><span class="material-icons">download</span></button>
            <button class="icon-btn" onclick="clearCollage()" title="Törlés"><span class="material-icons">delete_sweep</span></button>
        </div>

        <div class="glass-bubble">
            <div id="user-btn" onclick="openLoginModal()">Belépés</div>
            <div class="dropdown">
                <button class="icon-btn" title="Közös Munka"><span class="material-icons">group</span></button>
                <div class="dropdown-content">
                    <h4 style="margin:0 0 10px 0; border-bottom:1px solid #444; padding-bottom:5px;">Közös Kollázs</h4>
                    <div id="p2p-controls">
                        <select id="channel-select" style="width:100%; padding:8px; background:#333; color:white; border:none; border-radius:4px; margin-bottom:5px;">
                            <option value="collage_1">Szoba 1</option>
                            <option value="collage_2">Szoba 2</option>
                        </select>
                        <div style="display:flex; gap:5px;">
                            <button onclick="startHost()" style="flex:1; padding:5px; background:var(--accent-color); border:none; color:white; border-radius:4px; cursor:pointer;">HOST</button>
                            <button onclick="joinGuest()" style="flex:1; padding:5px; background:#4CAF50; border:none; color:white; border-radius:4px; cursor:pointer;">JOIN</button>
                        </div>
                    </div>
                    <div id="p2p-status" style="display:none;">
                        <div style="color:#4CAF50; font-size:12px; margin-bottom:5px;">● Kapcsolódva</div>
                        <button onclick="disconnectP2P()" style="width:100%; padding:5px; background:#f44336; border:none; color:white; border-radius:4px; cursor:pointer; margin-top:5px;">Kilépés</button>
                    </div>
                </div>
            </div>
            <div class="dropdown">
                <button class="icon-btn" title="Felhő"><span class="material-icons">cloud</span></button>
                <div class="dropdown-content">
                    <a href="#" onclick="handleDriveSave()" style="display:block; padding:8px; color:#e0e0e0; text-decoration:none;"><span class="material-icons" style="font-size:14px; vertical-align:middle">save</span> Mentés Drive-ra (HD)</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="floating-panel toolbar-left">
            <div class="section-title">Képek</div>
            <button class="big-btn" onclick="document.getElementById('img-input').click()">
                <span class="material-icons">add_photo_alternate</span>
                Képek Importálása
            </button>
            <input type="file" id="img-input" multiple accept="image/*" onchange="handleFiles(this.files)">

            <div style="height:10px;"></div>

            <div class="section-title">Sablonok</div>
            <div class="tool-grid">
                <button class="big-btn" onclick="applyLayout('grid')"><span class="material-icons">grid_view</span>Rács</button>
                <button class="big-btn" onclick="applyLayout('columns')"><span class="material-icons">view_column</span>Oszlop</button>
                <button class="big-btn" onclick="applyLayout('scatter')"><span class="material-icons">grain</span>Szórt</button>
                <button class="big-btn" onclick="applyLayout('rows')"><span class="material-icons">table_rows</span>Sorok</button>
            </div>

            <div style="height:10px;"></div>
            <div class="section-title">Beállítások</div>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px;">Háttér:</span>
                <input type="color" id="canvas-bg" value="#ffffff" onchange="updateCanvasBg(this.value)" style="width:30px; height:30px; border:none; padding:0; background:none;">
            </div>
            <select id="export-quality" class="settings-select">
                <option value="1">Normál (1x)</option>
                <option value="2">HD (2x)</option>
                <option value="4">Ultra (4x)</option>
            </select>
        </div>

        <div id="collage-area" onmousedown="deselectAll(event)">
            <div id="collage-canvas">
                </div>
        </div>
    </div>

    <div id="crop-modal">
        <div class="crop-container">
            <img id="image-to-crop" src="">
        </div>
        <div class="crop-controls">
            <button class="crop-btn active" onclick="setCropRatio(NaN, this)">Szabad</button>
            <button class="crop-btn" onclick="setCropRatio(1, this)">1:1</button>
            <button class="crop-btn" onclick="setCropRatio(4/3, this)">4:3</button>
            <button class="crop-btn" onclick="setCropRatio(16/9, this)">16:9</button>
            <div style="width:1px; height:30px; background:#555;"></div>
            <button class="crop-btn" style="background:#444;" onclick="closeCropModal()">Mégse</button>
            <button class="crop-btn action" onclick="applyCrop()">Kész (Apply)</button>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal">
            <h3>Bejelentkezés</h3>
            <input type="text" id="username" placeholder="Felhasználónév">
            <button onclick="login()">OK</button>
            <button onclick="document.getElementById('loginModal').style.display='none'" style="background:transparent; margin-right:10px;">Mégse</button>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        const canvas = document.getElementById('collage-canvas');
        let items = []; // { id, element, src }
        let selectedItem = null;
        let zCounter = 1;
        
        // Drag logic
        let isDragging = false, isResizing = false;
        let dragOffset = {x:0, y:0};
        let startSize = {w:0, h:0, x:0, y:0};

        // Crop logic
        let cropper = null;
        let croppingItemId = null;

        // --- IMAGE HANDLING ---
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => createCollageItem(e.target.result);
                reader.readAsDataURL(file);
            });
            document.getElementById('img-input').value = '';
        }

        function createCollageItem(src, remoteParams = null) {
            const id = remoteParams ? remoteParams.id : 'item_' + Date.now() + Math.random().toString(36).substr(2, 5);
            const zIndex = remoteParams ? remoteParams.z : zCounter++;

            const div = document.createElement('div');
            div.className = 'collage-item'; div.id = id; div.style.zIndex = zIndex;
            
            const img = document.createElement('img');
            img.src = src;
            img.onload = () => {
                if (!remoteParams) {
                    let w = img.naturalWidth, h = img.naturalHeight;
                    if (w > 300) { h = (300/w)*h; w = 300; }
                    div.style.width = w+'px'; div.style.height = h+'px';
                    div.style.left = (Math.random()*(canvas.clientWidth-w))+'px';
                    div.style.top = (Math.random()*(canvas.clientHeight-h))+'px';
                    syncCreate(id, src, parseFloat(div.style.left), parseFloat(div.style.top), w, h, zIndex);
                } else {
                    div.style.width = remoteParams.w+'px'; div.style.height = remoteParams.h+'px';
                    div.style.left = remoteParams.x+'px'; div.style.top = remoteParams.y+'px';
                }
            };

            const handle = document.createElement('div'); handle.className = 'resize-handle';
            
            // HUD with CROP Button
            const hud = document.createElement('div');
            hud.className = 'mini-hud';
            hud.innerHTML = `
                <button class="hud-btn" onclick="changeLayer('${id}', 1)" title="Előre"><span class="material-icons">arrow_upward</span></button>
                <button class="hud-btn" onclick="changeLayer('${id}', -1)" title="Hátra"><span class="material-icons">arrow_downward</span></button>
                <div style="width:1px; height:15px; background:rgba(255,255,255,0.3);"></div>
                <button class="hud-btn" onclick="openCropMode('${id}')" title="Vágás (Crop)"><span class="material-icons" style="color:#50fa7b">crop</span></button>
                <button class="hud-btn" onclick="deleteItem('${id}')" title="Törlés"><span class="material-icons" style="color:#ff5555">delete</span></button>
            `;

            div.appendChild(img); div.appendChild(handle); div.appendChild(hud);
            canvas.appendChild(div);

            const itemObj = { id, element: div, src };
            items.push(itemObj);

            div.onmousedown = (e) => startDrag(e, itemObj);
            handle.onmousedown = (e) => startResize(e, itemObj);
        }

        // --- CROP FUNCTIONALITY (NEW) ---
        function openCropMode(id) {
            croppingItemId = id;
            const item = items.find(i => i.id === id);
            if(!item) return;

            const modal = document.getElementById('crop-modal');
            const imgEl = document.getElementById('image-to-crop');
            
            // Load image into modal
            imgEl.src = item.element.querySelector('img').src;
            modal.style.display = 'flex';

            // Init Cropper
            if(cropper) cropper.destroy();
            cropper = new Cropper(imgEl, {
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true
            });
        }

        function setCropRatio(ratio, btn) {
            if(!cropper) return;
            cropper.setAspectRatio(ratio);
            document.querySelectorAll('.crop-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function closeCropModal() {
            document.getElementById('crop-modal').style.display = 'none';
            if(cropper) { cropper.destroy(); cropper = null; }
            croppingItemId = null;
        }

        function applyCrop() {
            if(!cropper || !croppingItemId) return;
            
            const croppedCanvas = cropper.getCroppedCanvas();
            const newDataUrl = croppedCanvas.toDataURL('image/png');
            
            // Update local item
            const item = items.find(i => i.id === croppingItemId);
            if(item) {
                const img = item.element.querySelector('img');
                img.src = newDataUrl;
                item.src = newDataUrl; // Update stored src
                
                // Adjust container ratio (optional but good UI)
                const currentW = parseFloat(item.element.style.width);
                const newRatio = croppedCanvas.width / croppedCanvas.height;
                // Keep width, adjust height
                item.element.style.height = (currentW / newRatio) + 'px';
                
                // SYNC: Send updated image to peers
                if(p2pHost) broadcast({ type: 'image_update', id: item.id, src: newDataUrl, w: currentW, h: (currentW / newRatio) });
                else if(conn) conn.send({ type: 'image_update', id: item.id, src: newDataUrl, w: currentW, h: (currentW / newRatio) });
            }

            closeCropModal();
        }

        // --- STANDARD INTERACTIONS ---
        function startDrag(e, item) {
            if (e.target.closest('.hud-btn') || e.target.classList.contains('resize-handle')) return;
            e.stopPropagation(); e.preventDefault();
            selectItem(item);
            isDragging = true;
            const rect = item.element.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left; dragOffset.y = e.clientY - rect.top;
        }
        function startResize(e, item) {
            e.stopPropagation(); e.preventDefault();
            isResizing = true; selectItem(item);
            startSize = { w: item.element.offsetWidth, h: item.element.offsetHeight, x: e.clientX, y: e.clientY };
        }
        function selectItem(item) {
            if (selectedItem) selectedItem.element.classList.remove('selected');
            selectedItem = item; item.element.classList.add('selected');
        }
        function deselectAll(e) {
            if (e.target.id === 'collage-area' || e.target.id === 'collage-canvas') {
                if (selectedItem) selectedItem.element.classList.remove('selected');
                selectedItem = null;
            }
        }
        window.addEventListener('mousemove', (e) => {
            if (!selectedItem) return;
            if (isDragging) {
                const r = canvas.getBoundingClientRect();
                selectedItem.element.style.left = (e.clientX - r.left - dragOffset.x) + 'px';
                selectedItem.element.style.top = (e.clientY - r.top - dragOffset.y) + 'px';
            } else if (isResizing) {
                const dx = e.clientX - startSize.x; const dy = e.clientY - startSize.y;
                selectedItem.element.style.width = (startSize.w + dx) + 'px';
                selectedItem.element.style.height = (startSize.h + dy) + 'px';
            }
        });
        window.addEventListener('mouseup', () => {
            if ((isDragging || isResizing) && selectedItem) syncUpdate(selectedItem);
            isDragging = false; isResizing = false;
        });

        function changeLayer(id, d) {
            const i = items.find(x=>x.id===id); if(!i) return;
            let z = parseInt(i.element.style.zIndex) + d; if(z<0) z=0;
            i.element.style.zIndex = z; if(z>=zCounter) zCounter=z+1;
            syncUpdate(i);
        }
        function deleteItem(id) {
            const idx = items.findIndex(x=>x.id===id); if(idx>-1) { items[idx].element.remove(); items.splice(idx,1); syncDelete(id); }
        }
        function updateCanvasBg(c) { canvas.style.backgroundColor=c; if(p2pHost) broadcast({type:'bg',c}); }
        
        function applyLayout(t) {
            if(items.length===0) return;
            const c=items.length, cw=canvas.offsetWidth, ch=canvas.offsetHeight;
            if(t==='grid'){ const cols=Math.ceil(Math.sqrt(c)), rows=Math.ceil(c/cols), cellW=cw/cols, cellH=ch/rows; items.forEach((it,i)=>{ it.element.style.width=(cellW-10)+'px'; it.element.style.height=(cellH-10)+'px'; it.element.style.left=(i%cols*cellW+5)+'px'; it.element.style.top=(Math.floor(i/cols)*cellH+5)+'px'; syncUpdate(it); }); }
            else if(t==='columns'){ const w=cw/c; items.forEach((it,i)=>{ it.element.style.width=(w-10)+'px'; it.element.style.height=(ch-20)+'px'; it.element.style.left=(i*w+5)+'px'; it.element.style.top='10px'; syncUpdate(it); }); }
            else if(t==='rows'){ const h=ch/c; items.forEach((it,i)=>{ it.element.style.width=(cw-20)+'px'; it.element.style.height=(h-10)+'px'; it.element.style.left='10px'; it.element.style.top=(i*h+5)+'px'; syncUpdate(it); }); }
            else if(t==='scatter'){ items.forEach(it=>{ it.element.style.width='200px'; it.element.style.height='auto'; it.element.style.left=(Math.random()*(cw-200))+'px'; it.element.style.top=(Math.random()*(ch-200))+'px'; syncUpdate(it); }); }
        }

        // --- SAVING (HD + SMART CROP) ---
        function renderImageCover(ctx, img, x, y, w, h) {
            ctx.save();
            ctx.beginPath(); ctx.rect(x, y, w, h); ctx.clip();
            const imgRatio = img.naturalWidth / img.naturalHeight;
            const targetRatio = w / h;
            let renderW, renderH;
            if (imgRatio > targetRatio) { renderH = h; renderW = img.naturalWidth * (h / img.naturalHeight); }
            else { renderW = w; renderH = img.naturalHeight * (w / img.naturalWidth); }
            ctx.drawImage(img, x + (w - renderW) / 2, y + (h - renderH) / 2, renderW, renderH);
            ctx.restore();
        }

        async function createExportBlob() {
            document.getElementById('loading-overlay').style.display = 'flex';
            const scale = parseInt(document.getElementById('export-quality').value) || 1;
            const ec = document.createElement('canvas');
            ec.width = canvas.offsetWidth * scale; ec.height = canvas.offsetHeight * scale;
            const ctx = ec.getContext('2d');
            ctx.fillStyle = canvas.style.backgroundColor || '#ffffff'; ctx.fillRect(0,0,ec.width,ec.height);
            [...items].sort((a,b)=>parseInt(a.element.style.zIndex)-parseInt(b.element.style.zIndex)).forEach(item=>{
                renderImageCover(ctx, item.element.querySelector('img'), parseFloat(item.element.style.left)*scale, parseFloat(item.element.style.top)*scale, parseFloat(item.element.style.width)*scale, parseFloat(item.element.style.height)*scale);
            });
            return new Promise(r=>ec.toBlob(b=>{document.getElementById('loading-overlay').style.display='none';r(b);},'image/png'));
        }
        async function saveCollage() { const b=await createExportBlob(); const l=document.createElement('a'); l.download=`AC_${Date.now()}.png`; l.href=URL.createObjectURL(b); l.click(); }
        function clearCollage() { if(confirm("Minden törlése?")){canvas.innerHTML=''; items=[]; if(p2pHost) broadcast({type:'clear'});} }

        // --- P2P ---
        let peer, conn, p2pHost=false, currentUser=null;
        function login(){currentUser=document.getElementById('username').value;if(currentUser){document.getElementById('user-btn').innerText=currentUser;document.getElementById('loginModal').style.display='none';}}
        function openLoginModal(){document.getElementById('loginModal').style.display='flex';}
        function startHost(){if(!currentUser){openLoginModal();return;}p2pHost=true;initPeer(document.getElementById('channel-select').value);}
        function joinGuest(){if(!currentUser){openLoginModal();return;}p2pHost=false;initPeer(null);}
        function initPeer(id){peer=new Peer(id); peer.on('open',()=>{document.getElementById('p2p-controls').style.display='none';document.getElementById('p2p-status').style.display='block';if(!p2pHost){conn=peer.connect(document.getElementById('channel-select').value);setupConn(conn);}}); peer.on('connection',c=>{setupConn(c); setTimeout(()=>{items.forEach(i=>{c.send({type:'create',id:i.id,src:i.src,x:parseFloat(i.element.style.left),y:parseFloat(i.element.style.top),w:parseFloat(i.element.style.width),h:parseFloat(i.element.style.height),z:parseInt(i.element.style.zIndex)});});},1000);});}
        function setupConn(c){c.on('data',d=>{
            if(d.type==='create'){if(!items.find(i=>i.id===d.id))createCollageItem(d.src,d);}
            else if(d.type==='update'){const i=items.find(x=>x.id===d.id);if(i){i.element.style.left=d.x+'px';i.element.style.top=d.y+'px';i.element.style.width=d.w+'px';i.element.style.height=d.h+'px';i.element.style.zIndex=d.z;}}
            else if(d.type==='delete'){deleteItem(d.id);}
            else if(d.type==='bg'){document.getElementById('canvas-bg').value=d.c;canvas.style.backgroundColor=d.c;}
            else if(d.type==='clear'){canvas.innerHTML='';items=[];}
            // NEW: Receive image update (Crop)
            else if(d.type==='image_update'){
                const i=items.find(x=>x.id===d.id);
                if(i){
                    i.element.querySelector('img').src = d.src;
                    i.src = d.src;
                    i.element.style.width = d.w + 'px';
                    i.element.style.height = d.h + 'px';
                }
            }
        });}
        function syncCreate(id,s,x,y,w,h,z){if(peer)broadcast({type:'create',id,src:s,x,y,w,h,z});}
        function syncUpdate(i){if(peer)broadcast({type:'update',id:i.id,x:parseFloat(i.element.style.left),y:parseFloat(i.element.style.top),w:parseFloat(i.element.style.width),h:parseFloat(i.element.style.height),z:parseInt(i.element.style.zIndex)});}
        function syncDelete(id){if(peer)broadcast({type:'delete',id});}
        function broadcast(m){if(p2pHost){for(let k in peer.connections)peer.connections[k].forEach(c=>c.send(m));}else if(conn)conn.send(m);}
        function disconnectP2P(){if(peer)peer.destroy();location.reload();}

        // Drive
        let gapiInited=false,gisInited=false,tokenClient;
        function gapiLoaded(){gapi.load('client',async()=>{await gapi.client.init({apiKey:'AIzaSyAfC2viqoOsVVjcShnqY2rrRsxdV7WHMEg',discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});gapiInited=true;});}
        function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:'138100233309-v575n23j2b6pdek9t9clvkg3immlkrdi.apps.googleusercontent.com',scope:'https://www.googleapis.com/auth/drive.file',callback:()=>{}});gisInited=true;}
        async function handleDriveSave(){if(!currentUser)return alert("Login!");if(!gapiInited)return;tokenClient.callback=async(r)=>{if(r.error)return;const b=await createExportBlob();const f=new FormData();f.append('metadata',new Blob([JSON.stringify({'name':`AC_HD_${Date.now()}.png`,'mimeType':'image/png'})],{type:'application/json'}));f.append('file',b);await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:new Headers({'Authorization':'Bearer '+gapi.client.getToken().access_token}),body:f});alert("Saved!");};tokenClient.requestAccessToken({prompt:''});}
    </script>
</body>
</html>
