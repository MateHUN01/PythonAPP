<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroCollage PRO MAX - P2P Collage & GIF Studio</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --workspace-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #2196F3;
            --border-color: #333;
            
            /* Glassmorphism */
            --glass-bg: rgba(30, 30, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --glass-blur: 20px;

            --btn-hover: rgba(255, 255, 255, 0.1);
            --handle-color: #fff;
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; user-select: none; }
        * { box-sizing: border-box; }

        /* --- COLLAGE WORKSPACE --- */
        .main-container { display: flex; height: 100vh; width: 100%; }
        
        #collage-area {
            flex: 1;
            background-color: var(--workspace-bg);
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #collage-canvas {
            width: 800px;
            height: 600px;
            background: #ffffff;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative;
            transition: width 0.3s, height 0.3s, background 0.3s;
            transform-style: preserve-3d; 
        }

        /* --- DRAGGABLE IMAGE ITEM --- */
        .collage-item {
            position: absolute;
            cursor: grab;
            user-select: none;
            border: 2px solid transparent;
            transition: border 0.1s;
            display: flex; justify-content: center; align-items: center;
            transform-origin: center center;
        }
        
        .collage-item.selected {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.4);
            z-index: 1000 !important; 
        }

        .collage-item-inner {
            width: 100%; height: 100%; overflow: hidden; position: relative; pointer-events: none;
        }

        .collage-item img {
            position: absolute; object-fit: fill; width: 100%; height: 100%; top: 0; left: 0; display: block;
        }

        /* --- HANDLES --- */
        .resize-handle, .rotate-handle {
            width: 12px; height: 12px; background: var(--accent-color); position: absolute; border-radius: 50%; display: none; border: 2px solid white; z-index: 2001; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .resize-handle { bottom: -6px; right: -6px; cursor: nwse-resize; width: 14px; height: 14px; }
        .rotate-handle { top: -30px; left: 50%; transform: translateX(-50%); cursor: grab; background: #ff9800; width: 16px; height: 16px; display: none; justify-content: center; align-items: center; }
        .rotate-connector { position: absolute; top: -30px; left: 50%; width: 2px; height: 30px; background: var(--accent-color); display: none; z-index: 2000; }
        .collage-item.selected .resize-handle, .collage-item.selected .rotate-handle, .collage-item.selected .rotate-connector { display: flex; }

        /* --- MINI HUD --- */
        .mini-hud {
            position: absolute; top: -75px; left: 50%; transform: translateX(-50%); background: var(--glass-bg); backdrop-filter: blur(10px); padding: 5px; border-radius: 8px; border: 1px solid var(--glass-border); display: none; gap: 5px; z-index: 99999; white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .collage-item.selected .mini-hud { display: flex; }
        .hud-btn { background: transparent; border: none; color: white; cursor: pointer; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .hud-btn:hover { background: rgba(255,255,255,0.2); }
        .hud-divider { width:1px; height:18px; background:rgba(255,255,255,0.2); margin:0 2px; align-self:center; }

        /* --- UI PANELEK --- */
        .floating-panel {
            position: absolute; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; z-index: 100;
        }
        .toolbar-left { top: 100px; left: 20px; width: 220px; }
        .section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; opacity: 0.6; margin-bottom: 5px; letter-spacing: 1px;}
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .big-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 6px; cursor: pointer; font-size: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; }
        .big-btn:hover { background: var(--btn-hover); border-color: var(--accent-color); }
        input[type="file"] { display: none; }

        /* --- HEADER --- */
        .header-wrapper { position: fixed; top: 25px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; z-index: 1000; pointer-events: none; }
        .glass-bubble { pointer-events: auto; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); border-radius: 100px; padding: 6px 15px; display: flex; align-items: center; gap: 10px; }
        .app-title { font-weight: 700; font-size: 14px; color: var(--text-color); display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: transparent; border: none; color: var(--text-color); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: var(--btn-hover); }
        #user-btn { cursor: pointer; font-size:12px; opacity:0.8; margin-right:5px; padding: 6px 12px; border-radius: 20px; background: rgba(255,255,255,0.05); }

        /* P2P & Dropdowns */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { opacity: 0; visibility: hidden; position: absolute; right: 0; top: 45px; background: var(--glass-bg); backdrop-filter: blur(20px); min-width: 250px; border-radius: 12px; border: 1px solid var(--glass-border); padding: 10px; transition: 0.2s; transform: translateY(-10px); }
        .dropdown:hover .dropdown-content { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: #222; padding: 20px; border-radius: 12px; width: 300px; border: 1px solid #444; color: #fff; }
        .modal input, .modal select { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: white; margin-bottom: 10px; border-radius: 4px; }
        .modal button { padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; float: right; margin-left: 10px; }
        .modal button.secondary { background: transparent; border: 1px solid #555; }

        /* Crop, Export, Toast, Loading - same as before */
        #cropModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 20000; flex-direction: column; align-items: center; justify-content: center; }
        .crop-container { position: relative; max-width: 80vw; max-height: 70vh; border: 1px solid #444; overflow: hidden; background: #000; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .crop-container img { display: block; max-width: 100%; max-height: 70vh; pointer-events: none; opacity: 0.4; }
        .crop-box { position: absolute; top: 0; left: 0; width: 100px; height: 100px; border: 2px solid var(--accent-color); box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); cursor: move; background-image: inherit; background-size: inherit; background-repeat: no-repeat; }
        .ch-handle { position: absolute; width: 14px; height: 14px; background: white; border: 2px solid var(--accent-color); border-radius: 50%; z-index: 2; }
        .ch-tl { top: -7px; left: -7px; cursor: nw-resize; } .ch-tr { top: -7px; right: -7px; cursor: ne-resize; } .ch-bl { bottom: -7px; left: -7px; cursor: sw-resize; } .ch-br { bottom: -7px; right: -7px; cursor: se-resize; }
        .ch-t { top: -7px; left: 50%; transform: translateX(-50%); cursor: n-resize; } .ch-b { bottom: -7px; left: 50%; transform: translateX(-50%); cursor: s-resize; } .ch-l { left: -7px; top: 50%; transform: translateY(-50%); cursor: w-resize; } .ch-r { right: -7px; top: 50%; transform: translateY(-50%); cursor: e-resize; }
        .crop-controls { margin-top: 20px; display: flex; gap: 10px; } .crop-btn { padding: 12px 24px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; } .crop-save { background: var(--accent-color); color: white; } .crop-cancel { background: transparent; border: 1px solid #555; color: white; }
        .export-option { display:block; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; border:1px solid transparent; } .export-option.active { background: rgba(33, 150, 243, 0.2); border-color: var(--accent-color); }
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10001; } .toast { background: rgba(33, 150, 243, 0.9); backdrop-filter: blur(10px); color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-size: 13px; animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 20px; } .loader-spinner { border: 4px solid rgba(255, 255, 255, 0.1); width: 48px; height: 48px; border-radius: 50%; border-left-color: var(--accent-color); animation: spin 1s linear infinite; } .progress-bar { width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 5px; } #loading-progress { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.3s ease; }

        /* --- GIF STUDIO STYLES (ÚJRATERVEZVE DESKTOPRA) --- */
        #gif-studio {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #121212; z-index: 5000; display: none;
            /* Flex layout a fő tartalomhoz */
            flex-direction: row; 
        }

        /* Bal oldali vászon terület */
        .gif-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(#222 1px, #121212 1px);
            background-size: 30px 30px;
            position: relative;
        }

        /* Jobb oldali eszközpanel */
        .gif-sidebar-panel {
            width: 320px;
            background: var(--workspace-bg);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5);
            z-index: 5001;
            overflow-y: auto;
        }

        .gif-sidebar-header {
            font-size: 18px; font-weight: 700; color: white; display:flex; align-items:center; gap:10px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 15px;
        }

        .panel-section { display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .panel-label { font-size: 11px; text-transform: uppercase; font-weight: 600; color: #888; letter-spacing: 1px; }

        /* Színrács */
        .color-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
        }
        .color-swatch {
            width: 100%; padding-top: 100%; /* square */
            border-radius: 4px; cursor: pointer; border: 2px solid transparent; position: relative;
        }
        .color-swatch.active { border-color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 2; }
        
        /* Egyedi színválasztó */
        .custom-color-input {
            width: 100%; height: 35px; border: none; background: none; padding: 0; cursor: pointer;
        }

        /* Ecset méretek */
        .brush-sizes { display: flex; gap: 5px; justify-content: space-between; }
        .brush-btn {
            flex: 1; height: 35px; background: #333; border: 1px solid #444; border-radius: 4px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center;
        }
        .brush-btn:hover { background: #444; }
        .brush-btn.active { background: var(--accent-color); border-color: var(--accent-color); }
        .brush-dot { background: white; border-radius: 50%; }

        /* Vászon */
        .gif-canvas-container {
            position: relative; width: 500px; height: 500px;
            background: #fff; box-shadow: 0 0 60px rgba(0,0,0,0.7);
            border: 4px solid #333;
        }
        #gif-drawing-canvas { position: absolute; top: 0; left: 0; z-index: 5; cursor: crosshair; }
        #gif-onion-skin { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; opacity: 0.25; pointer-events: none; }

        /* Idővonal lentre */
        .gif-timeline {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px; max-width: 70vw; overflow-x: auto; padding: 10px;
            background: var(--glass-bg); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid var(--glass-border);
        }
        .gif-frame-thumb { width: 40px; height: 40px; background: white; border: 1px solid #555; opacity: 0.5; flex-shrink: 0; }
        .gif-frame-thumb.active { border: 2px solid var(--accent-color); opacity: 1; transform: scale(1.1); }

        .action-btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-green { background: #4CAF50; color: white; }
        .btn-green:hover { background: #43A047; }
        .btn-blue { background: var(--accent-color); color: white; }
        .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #f44336; color: white; }
        .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }
        .btn-outline:hover { background: rgba(255,255,255,0.05); border-color: #888; }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-spinner"></div>
        <div id="loading-text">Feldolgozás...</div>
        <div class="progress-bar"><div id="loading-progress"></div></div>
    </div>
    
    <div class="toast-container" id="toast-area"></div>

    <div class="header-wrapper">
        <div class="glass-bubble">
            <div class="app-title">
                <span class="material-icons" style="color:var(--accent-color)">dashboard_customize</span>
                AeroCollage PRO MAX
            </div>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>
            <button class="icon-btn" onclick="undo()" title="Visszavonás (Ctrl+Z)"><span class="material-icons">undo</span></button>
            <button class="icon-btn" onclick="redo()" title="Mégsem (Ctrl+Y)"><span class="material-icons">redo</span></button>

            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>
            <button class="icon-btn" onclick="openExportModal()" title="Mentés beállításokkal"><span class="material-icons">download</span></button>
            <button class="icon-btn" onclick="clearCollage()" title="Összes törlése"><span class="material-icons">delete_sweep</span></button>
        </div>

        <div class="glass-bubble">
            <div id="user-btn" onclick="openLoginModal()">Belépés</div>
            
            <button class="icon-btn" onclick="openGifStudio()" title="GIF Animátor Stúdió" style="color: #FF4081; background: rgba(255, 64, 129, 0.1);"><span class="material-icons">animation</span></button>

            <div class="dropdown">
                <button class="icon-btn" title="Közös Munka"><span class="material-icons">group</span></button>
                <div class="dropdown-content">
                    <h4 style="margin:0 0 10px 0; border-bottom:1px solid #444; padding-bottom:5px;">Közös Kollázs</h4>
                    <div id="p2p-controls">
                        <select id="channel-select" style="width:100%; padding:8px; background:#333; color:white; border:none; border-radius:4px; margin-bottom:5px;">
                            <option value="collage_1">Szoba 1</option>
                            <option value="collage_2">Szoba 2</option>
                        </select>
                        <div style="display:flex; gap:5px;">
                            <button onclick="startHost()" style="flex:1; padding:5px; background:var(--accent-color); border:none; color:white; border-radius:4px; cursor:pointer;">HOST</button>
                            <button onclick="joinGuest()" style="flex:1; padding:5px; background:#4CAF50; border:none; color:white; border-radius:4px; cursor:pointer;">JOIN</button>
                        </div>
                    </div>
                    <div id="p2p-status" style="display:none;">
                        <div style="color:#4CAF50; font-size:12px; margin-bottom:5px;">● Kapcsolódva</div>
                        <div id="user-list"></div>
                        <button onclick="disconnectP2P()" style="width:100%; padding:5px; background:#f44336; border:none; color:white; border-radius:4px; cursor:pointer; margin-top:5px;">Kilépés</button>
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="icon-btn" title="Felhő"><span class="material-icons">cloud</span></button>
                <div class="dropdown-content">
                    <a href="#" onclick="handleDriveSave()" style="display:block; padding:8px; color:#e0e0e0; text-decoration:none;"><span class="material-icons" style="font-size:14px; vertical-align:middle">save</span> Mentés Drive-ra</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="floating-panel toolbar-left">
            <div class="section-title">Képek</div>
            <button class="big-btn" onclick="document.getElementById('img-input').click()">
                <span class="material-icons">add_photo_alternate</span>
                Képek Importálása
            </button>
            <input type="file" id="img-input" multiple accept="image/*" onchange="handleFiles(this.files)" onclick="this.value=null;">

            <div style="height:10px;"></div>

            <div class="section-title">Sablonok (Auto)</div>
            <div class="tool-grid">
                <button class="big-btn" onclick="applyLayout('grid')">
                    <span class="material-icons">grid_view</span>
                    Rács
                </button>
                <button class="big-btn" onclick="applyLayout('columns')">
                    <span class="material-icons">view_column</span>
                    Oszlopok
                </button>
                <button class="big-btn" onclick="applyLayout('scatter')">
                    <span class="material-icons">grain</span>
                    Szórt
                </button>
                <button class="big-btn" onclick="applyLayout('rows')">
                    <span class="material-icons">table_rows</span>
                    Sorok
                </button>
            </div>

            <div style="height:10px;"></div>

            <div class="section-title">Vászon Beállítások</div>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px;">Háttérszín:</span>
                <input type="color" id="canvas-bg" value="#ffffff" onchange="updateCanvasBg(this.value)" style="width:30px; height:30px; border:none; padding:0; background:none;">
            </div>
        </div>

        <div id="collage-area" onmousedown="deselectAll(event)">
            <div id="collage-canvas"></div>
        </div>
    </div>

    <div id="gif-studio">
        <div class="gif-main-area">
            <div class="gif-canvas-container">
                <img id="gif-onion-skin" src="">
                <canvas id="gif-drawing-canvas" width="500" height="500"></canvas>
            </div>
            
            <div class="gif-timeline" id="gif-frames-container">
                </div>
        </div>

        <div class="gif-sidebar-panel">
            <div class="gif-sidebar-header">
                <span class="material-icons" style="color:#FF4081">animation</span> Stúdió
                <button onclick="closeGifStudio()" class="icon-btn" style="margin-left:auto;"><span class="material-icons">close</span></button>
            </div>

            <div class="panel-section">
                <div class="panel-label">Eszközök & Ecsetek</div>
                <div class="brush-sizes">
                    <div class="brush-btn active" onclick="setGifTool('brush', 2, this)" title="Vékony (2px)"><div class="brush-dot" style="width:2px; height:2px;"></div></div>
                    <div class="brush-btn" onclick="setGifTool('brush', 5, this)" title="Közepes (5px)"><div class="brush-dot" style="width:5px; height:5px;"></div></div>
                    <div class="brush-btn" onclick="setGifTool('brush', 10, this)" title="Vastag (10px)"><div class="brush-dot" style="width:10px; height:10px;"></div></div>
                    <div class="brush-btn" onclick="setGifTool('brush', 20, this)" title="Óriás (20px)"><div class="brush-dot" style="width:15px; height:15px;"></div></div>
                    <div class="brush-btn" onclick="setGifTool('eraser', 20, this)" title="Radír"><span class="material-icons" style="font-size:16px;">backspace</span></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px; color:#888;">Finomhangolás:</span>
                    <input type="range" min="1" max="50" value="5" id="brush-slider" oninput="updateBrushSlider(this.value)" style="width:60%;">
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-label">Színpaletta</div>
                <div class="color-grid">
                    <div class="color-swatch active" style="background:black;" onclick="setGifColor('black', this)"></div>
                    <div class="color-swatch" style="background:#555;" onclick="setGifColor('#555', this)"></div>
                    <div class="color-swatch" style="background:#F44336;" onclick="setGifColor('#F44336', this)"></div>
                    <div class="color-swatch" style="background:#E91E63;" onclick="setGifColor('#E91E63', this)"></div>
                    <div class="color-swatch" style="background:#9C27B0;" onclick="setGifColor('#9C27B0', this)"></div>
                    <div class="color-swatch" style="background:#673AB7;" onclick="setGifColor('#673AB7', this)"></div>
                    <div class="color-swatch" style="background:#3F51B5;" onclick="setGifColor('#3F51B5', this)"></div>
                    <div class="color-swatch" style="background:#2196F3;" onclick="setGifColor('#2196F3', this)"></div>
                    <div class="color-swatch" style="background:#00BCD4;" onclick="setGifColor('#00BCD4', this)"></div>
                    <div class="color-swatch" style="background:#009688;" onclick="setGifColor('#009688', this)"></div>
                    <div class="color-swatch" style="background:#4CAF50;" onclick="setGifColor('#4CAF50', this)"></div>
                    <div class="color-swatch" style="background:#8BC34A;" onclick="setGifColor('#8BC34A', this)"></div>
                    <div class="color-swatch" style="background:#FFEB3B;" onclick="setGifColor('#FFEB3B', this)"></div>
                    <div class="color-swatch" style="background:#FFC107;" onclick="setGifColor('#FFC107', this)"></div>
                    <div class="color-swatch" style="background:#FF9800;" onclick="setGifColor('#FF9800', this)"></div>
                    <div class="color-swatch" style="background:#FF5722;" onclick="setGifColor('#FF5722', this)"></div>
                    <div class="color-swatch" style="background:#795548;" onclick="setGifColor('#795548', this)"></div>
                    <div style="grid-column: span 1; position: relative;">
                        <input type="color" class="custom-color-input" onchange="setGifColor(this.value, null)" title="Egyedi szín">
                        <span class="material-icons" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); pointer-events:none; font-size:16px;">colorize</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-label">Vezérlés</div>
                <div style="font-size:13px; margin-bottom:5px; text-align:center; font-weight:bold; color:var(--accent-color);" id="frame-counter">Kocka: 1</div>
                
                <button class="action-btn btn-green" onclick="nextGifFrame()">
                    <span class="material-icons">skip_next</span> ÚJ RÉTEG
                </button>
                <button class="action-btn btn-outline" onclick="clearGifCanvas()">
                    <span class="material-icons">delete</span> VÁSZON TÖRLÉSE
                </button>
            </div>

            <div class="panel-section" style="margin-top:auto;">
                <button class="action-btn btn-blue" onclick="finishAndExportGif()">
                    <span class="material-icons">save_alt</span> GIF EXPORTÁLÁSA
                </button>
            </div>
        </div>
    </div>

    <div id="cropModal">
        <div class="crop-header"><h3>Kép Vágása (Crop)</h3><p style="font-size:12px; opacity:0.7;">Jelöld ki a megtartani kívánt területet.</p></div>
        <div class="crop-container" id="crop-container">
            <img id="crop-target-img" src="" alt="Vágandó kép">
            <div class="crop-box" id="crop-box" onmousedown="startCropDrag(event)">
                <div class="ch-handle ch-tl" onmousedown="startCropResize(event, 'tl')"></div><div class="ch-handle ch-tr" onmousedown="startCropResize(event, 'tr')"></div><div class="ch-handle ch-bl" onmousedown="startCropResize(event, 'bl')"></div><div class="ch-handle ch-br" onmousedown="startCropResize(event, 'br')"></div><div class="ch-handle ch-t" onmousedown="startCropResize(event, 't')"></div><div class="ch-handle ch-b" onmousedown="startCropResize(event, 'b')"></div><div class="ch-handle ch-l" onmousedown="startCropResize(event, 'l')"></div><div class="ch-handle ch-r" onmousedown="startCropResize(event, 'r')"></div>
            </div>
        </div>
        <div class="crop-controls"><button class="crop-btn crop-cancel" onclick="closeCropModal()"><span class="material-icons">close</span> Mégse</button><button class="crop-btn crop-save" onclick="applyCrop()"><span class="material-icons">crop</span> Vágás Mentése</button></div>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal"><h3>Bejelentkezés</h3><p style="font-size:12px; color:#aaa; margin-bottom:10px;">Add meg a neved a közös munkához.</p><input type="text" id="username" placeholder="Felhasználónév"><div style="overflow:hidden;"><button onclick="login()">OK</button><button class="secondary" onclick="document.getElementById('loginModal').style.display='none'">Mégse</button></div></div>
    </div>

    <div id="exportModal" class="modal-overlay">
        <div class="modal"><h3>Exportálás</h3><div class="export-option active" onclick="setExportQuality(1, this)"><div style="font-weight:bold;">Normál (Screen)</div><div style="font-size:11px; opacity:0.7;">Gyors mentés, képernyőméret (1x)</div></div><div class="export-option" onclick="setExportQuality(3, this)"><div style="font-weight:bold;">HD (Print Quality)</div><div style="font-size:11px; opacity:0.7;">Nagy felbontás, nyomtatáshoz (3x skálázás)</div></div><div style="overflow:hidden; margin-top:15px;"><button onclick="executeSave()">Mentés</button><button class="secondary" onclick="document.getElementById('exportModal').style.display='none'">Mégse</button></div></div>
    </div>

    <script>
        // --- CORE VARIABLES ---
        const canvas = document.getElementById('collage-canvas');
        let items = []; let selectedItem = null; let zCounter = 1;
        let isDragging = false; let isResizing = false; let isRotating = false;
        let dragOffset = { x: 0, y: 0 }; let startSize = { w: 0, h: 0, x: 0, y: 0 }; let rotationStartCenter = { x: 0, y: 0 };
        let exportScale = 1; 

        // --- CROP VARIABLES ---
        let cropTargetId = null; let isCropDragging = false; let isCropResizing = false; let cropResizeDir = ''; let cropStartPos = {x:0, y:0, boxL:0, boxT:0, boxW:0, boxH:0}; let tempCropImage = new Image();

        // --- GIF MAKER VARIABLES ---
        let gifFrames = []; 
        let isGifDrawing = false;
        let gifCanvas = document.getElementById('gif-drawing-canvas');
        let gifCtx = gifCanvas.getContext('2d');
        let gifColor = 'black';
        let gifLineWidth = 2; // Default 2px
        let lastGifPos = {x:0, y:0};
        let isEraser = false; // Új változó a radírhoz

        // --- IMAGE HANDLING ---
        async function handleFiles(fileList) {
            if (!fileList || fileList.length === 0) return;
            const loadingOverlay = document.getElementById('loading-overlay'); const loadingText = document.getElementById('loading-text'); const loadingProgress = document.getElementById('loading-progress');
            loadingOverlay.style.display = 'flex'; loadingProgress.style.width = '0%';
            const files = Array.from(fileList); let processedCount = 0;
            const processFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => { createCollageItem(img.src); resolve(); };
                        img.onerror = () => { console.error("Hiba: " + file.name); resolve(); };
                    };
                    reader.onerror = () => { resolve(); }; reader.readAsDataURL(file);
                });
            };
            const promises = files.map(async (file) => { await processFile(file); processedCount++; const percent = Math.round((processedCount / files.length) * 100); loadingText.innerText = `Feldolgozás: ${processedCount} / ${files.length}`; loadingProgress.style.width = `${percent}%`; });
            try { await Promise.allSettled(promises); } catch (err) { console.error(err); } finally { setTimeout(() => { loadingOverlay.style.display = 'none'; loadingText.innerText = "Feldolgozás..."; loadingProgress.style.width = '0%'; }, 300); document.getElementById('img-input').value = ''; saveState(); }
        }

        function createCollageItem(src, remoteParams = null) {
            const id = remoteParams ? remoteParams.id : 'item_' + Date.now() + Math.random().toString(36).substr(2, 5);
            const zIndex = remoteParams ? remoteParams.z : zCounter++;
            const rotation = remoteParams ? remoteParams.rotation : 0;
            const div = document.createElement('div'); div.className = 'collage-item'; div.id = id; div.style.zIndex = zIndex; div.style.transform = `rotate(${rotation}deg)`;
            const innerDiv = document.createElement('div'); innerDiv.className = 'collage-item-inner';
            const img = document.createElement('img'); img.src = src; const originalSrc = remoteParams && remoteParams.originalSrc ? remoteParams.originalSrc : src;
            img.onload = () => {
                if (!remoteParams) {
                    let w = img.naturalWidth; let h = img.naturalHeight; if (w > 300) { h = (300/w)*h; w = 300; }
                    div.style.width = w + 'px'; div.style.height = h + 'px'; div.style.left = (Math.random() * (canvas.clientWidth - w)) + 'px'; div.style.top = (Math.random() * (canvas.clientHeight - h)) + 'px';
                    syncCreate(id, src, parseFloat(div.style.left), parseFloat(div.style.top), w, h, zIndex, rotation, originalSrc);
                } else { div.style.width = remoteParams.w + 'px'; div.style.height = remoteParams.h + 'px'; div.style.left = remoteParams.x + 'px'; div.style.top = remoteParams.y + 'px'; }
            };
            if(img.complete && !remoteParams) { img.onload(); }
            
            const resizeHandle = document.createElement('div'); resizeHandle.className = 'resize-handle';
            const rotateConnector = document.createElement('div'); rotateConnector.className = 'rotate-connector';
            const rotateHandle = document.createElement('div'); rotateHandle.className = 'rotate-handle'; rotateHandle.innerHTML = '<span class="material-icons" style="font-size:14px; color:white;">refresh</span>';
            const hud = document.createElement('div'); hud.className = 'mini-hud';
            hud.innerHTML = `<button class="hud-btn" onclick="changeLayer('${id}', 1)"><span class="material-icons" style="font-size:16px">arrow_upward</span></button><button class="hud-btn" onclick="changeLayer('${id}', -1)"><span class="material-icons" style="font-size:16px">arrow_downward</span></button><div class="hud-divider"></div><button class="hud-btn" onclick="openCropEditor('${id}')"><span class="material-icons" style="font-size:16px">crop</span></button><div class="hud-divider"></div><button class="hud-btn" style="color:#ff5555" onclick="deleteItem('${id}')"><span class="material-icons" style="font-size:16px">delete</span></button>`;
            innerDiv.appendChild(img); div.appendChild(innerDiv); div.appendChild(resizeHandle); div.appendChild(rotateConnector); div.appendChild(rotateHandle); div.appendChild(hud); canvas.appendChild(div);
            const itemObj = { id, element: div, src, rotation, originalSrc }; items.push(itemObj);
            div.onmousedown = (e) => startDrag(e, itemObj); resizeHandle.onmousedown = (e) => startResize(e, itemObj); rotateHandle.onmousedown = (e) => startRotate(e, itemObj);
        }

        // --- CROP LOGIC ---
        function openCropEditor(id) {
            const item = items.find(i => i.id === id); if(!item) return;
            cropTargetId = id; const modal = document.getElementById('cropModal'); const targetImg = document.getElementById('crop-target-img'); const cropBox = document.getElementById('crop-box'); const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex'; document.getElementById('loading-text').innerText = "Szerkesztő betöltése...";
            tempCropImage.src = item.src;
            tempCropImage.onload = () => {
                targetImg.src = tempCropImage.src; cropBox.style.backgroundImage = `url('${tempCropImage.src}')`; modal.style.display = 'flex'; loadingOverlay.style.display = 'none';
                const containerRect = document.getElementById('crop-container').getBoundingClientRect(); const imgRect = targetImg.getBoundingClientRect();
                const margin = 20; let cw = imgRect.width - margin*2; let ch = imgRect.height - margin*2; if(cw < 50) cw = 50; if(ch < 50) ch = 50;
                cropBox.style.left = (imgRect.left - containerRect.left + margin) + 'px'; cropBox.style.top = (imgRect.top - containerRect.top + margin) + 'px'; cropBox.style.width = cw + 'px'; cropBox.style.height = ch + 'px'; updateCropBoxBackground();
            };
        }
        function updateCropBoxBackground() {
            const cropBox = document.getElementById('crop-box'); const targetImg = document.getElementById('crop-target-img'); const container = document.getElementById('crop-container');
            const imgRect = targetImg.getBoundingClientRect(); const containerRect = container.getBoundingClientRect();
            const boxLeft = parseFloat(cropBox.style.left); const boxTop = parseFloat(cropBox.style.top);
            cropBox.style.backgroundPosition = `${(imgRect.left - containerRect.left) - boxLeft}px ${(imgRect.top - containerRect.top) - boxTop}px`; cropBox.style.backgroundSize = `${imgRect.width}px ${imgRect.height}px`;
        }
        function closeCropModal() { document.getElementById('cropModal').style.display = 'none'; cropTargetId = null; }
        function applyCrop() {
            if(!cropTargetId) return; document.getElementById('loading-overlay').style.display = 'flex'; document.getElementById('loading-text').innerText = "Vágás alkalmazása...";
            setTimeout(() => {
                const item = items.find(i => i.id === cropTargetId); const targetImg = document.getElementById('crop-target-img'); const cropBox = document.getElementById('crop-box'); const containerRect = document.getElementById('crop-container').getBoundingClientRect(); const imgRect = targetImg.getBoundingClientRect();
                let boxLeft = parseFloat(cropBox.style.left) - (imgRect.left - containerRect.left); let boxTop = parseFloat(cropBox.style.top) - (imgRect.top - containerRect.top);
                const scaleX = tempCropImage.naturalWidth / imgRect.width; const scaleY = tempCropImage.naturalHeight / imgRect.height;
                const canvasGen = document.createElement('canvas'); canvasGen.width = parseFloat(cropBox.style.width) * scaleX; canvasGen.height = parseFloat(cropBox.style.height) * scaleY;
                const ctx = canvasGen.getContext('2d'); ctx.drawImage(tempCropImage, boxLeft * scaleX, boxTop * scaleY, canvasGen.width, canvasGen.height, 0, 0, canvasGen.width, canvasGen.height);
                const newCroppedSrc = canvasGen.toDataURL('image/png'); item.src = newCroppedSrc; item.element.querySelector('img').src = newCroppedSrc;
                item.element.style.height = (parseFloat(item.element.style.width) * (canvasGen.height / canvasGen.width)) + 'px';
                syncUpdate(item); closeCropModal(); document.getElementById('loading-overlay').style.display = 'none'; showToast("Kép sikeresen vágva!"); saveState();
            }, 100);
        }
        function startCropDrag(e) { if(e.target.classList.contains('ch-handle')) return; e.stopPropagation(); e.preventDefault(); isCropDragging = true; const box = document.getElementById('crop-box'); cropStartPos = { x: e.clientX, y: e.clientY, boxL: parseFloat(box.style.left)||0, boxT: parseFloat(box.style.top)||0 }; }
        function startCropResize(e, dir) { e.stopPropagation(); e.preventDefault(); isCropResizing = true; cropResizeDir = dir; const box = document.getElementById('crop-box'); cropStartPos = { x: e.clientX, y: e.clientY, boxL: parseFloat(box.style.left)||0, boxT: parseFloat(box.style.top)||0, boxW: parseFloat(box.style.width)||0, boxH: parseFloat(box.style.height)||0 }; }
        document.getElementById('cropModal').addEventListener('mousemove', (e) => {
            if (!isCropDragging && !isCropResizing) return;
            const box = document.getElementById('crop-box'); const img = document.getElementById('crop-target-img'); const container = document.getElementById('crop-container'); const cRect = container.getBoundingClientRect(); const iRect = img.getBoundingClientRect();
            const minX = iRect.left - cRect.left, minY = iRect.top - cRect.top; const maxX = minX + iRect.width, maxY = minY + iRect.height;
            let newL = parseFloat(box.style.left), newT = parseFloat(box.style.top), newW = parseFloat(box.style.width), newH = parseFloat(box.style.height);
            if (isCropDragging) { newL = cropStartPos.boxL + (e.clientX - cropStartPos.x); newT = cropStartPos.boxT + (e.clientY - cropStartPos.y); }
            if (isCropResizing) { const dx = e.clientX - cropStartPos.x; const dy = e.clientY - cropStartPos.y; if (cropResizeDir.includes('r')) newW = cropStartPos.boxW + dx; if (cropResizeDir.includes('l')) { newL = cropStartPos.boxL + dx; newW = cropStartPos.boxW - dx; } if (cropResizeDir.includes('b')) newH = cropStartPos.boxH + dy; if (cropResizeDir.includes('t')) { newT = cropStartPos.boxT + dy; newH = cropStartPos.boxH - dy; } }
            if (newW < 30) newW = 30; if (newH < 30) newH = 30;
            if (newL < minX) { if(isCropResizing && cropResizeDir.includes('l')) newW += (newL-minX); newL = minX; } if (newT < minY) { if(isCropResizing && cropResizeDir.includes('t')) newH += (newT-minY); newT = minY; }
            if (newL + newW > maxX) { if(isCropResizing && cropResizeDir.includes('r')) newW = maxX - newL; else newL = maxX - newW; } if (newT + newH > maxY) { if(isCropResizing && cropResizeDir.includes('b')) newH = maxY - newT; else newT = maxY - newH; }
            box.style.left = newL+'px'; box.style.top = newT+'px'; box.style.width = newW+'px'; box.style.height = newH+'px'; updateCropBoxBackground();
        });
        document.getElementById('cropModal').addEventListener('mouseup', () => { isCropDragging = false; isCropResizing = false; });

        // --- MAIN INTERACTION ENGINE ---
        function startDrag(e, item) { if (e.target.closest('.hud-btn') || e.target.classList.contains('resize-handle') || e.target.classList.contains('rotate-handle')) return; e.stopPropagation(); e.preventDefault(); selectItem(item); isDragging = true; const rect = item.element.getBoundingClientRect(); dragOffset.x = e.clientX - rect.left; dragOffset.y = e.clientY - rect.top; }
        function startResize(e, item) { e.stopPropagation(); e.preventDefault(); isResizing = true; selectItem(item); startSize = { w: item.element.offsetWidth, h: item.element.offsetHeight, x: e.clientX, y: e.clientY }; }
        function startRotate(e, item) { e.stopPropagation(); e.preventDefault(); isRotating = true; selectItem(item); const rect = item.element.getBoundingClientRect(); rotationStartCenter = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 }; }
        function selectItem(item) { if (selectedItem) selectedItem.element.classList.remove('selected'); selectedItem = item; item.element.classList.add('selected'); }
        function deselectAll(e) { if (e.target.id === 'collage-area' || e.target.id === 'collage-canvas') { if (selectedItem) selectedItem.element.classList.remove('selected'); selectedItem = null; } }
        window.addEventListener('mousemove', (e) => {
            if (!selectedItem || document.getElementById('cropModal').style.display === 'flex') return;
            if (isDragging) { const canvasRect = canvas.getBoundingClientRect(); selectedItem.element.style.left = (e.clientX - canvasRect.left - dragOffset.x) + 'px'; selectedItem.element.style.top = (e.clientY - canvasRect.top - dragOffset.y) + 'px'; }
            else if (isResizing) { const dx = e.clientX - startSize.x; const dy = e.clientY - startSize.y; selectedItem.element.style.width = Math.max(30, startSize.w + dx) + 'px'; selectedItem.element.style.height = Math.max(30, startSize.h + dy) + 'px'; }
            else if (isRotating) { const deltaX = e.clientX - rotationStartCenter.x; const deltaY = e.clientY - rotationStartCenter.y; let angleDeg = Math.atan2(deltaY, deltaX) * (180 / Math.PI) + 90; selectedItem.rotation = angleDeg; selectedItem.element.style.transform = `rotate(${angleDeg}deg)`; }
        });
        window.addEventListener('mouseup', () => { if ((isDragging || isResizing || isRotating) && selectedItem) { syncUpdate(selectedItem); saveState(); } isDragging = false; isResizing = false; isRotating = false; });

        // --- UTILS ---
        function changeLayer(id, direction) { const item = items.find(i => i.id === id); if (!item) return; let newZ = Math.max(0, parseInt(item.element.style.zIndex) + direction); item.element.style.zIndex = newZ; if (newZ >= zCounter) zCounter = newZ + 1; syncUpdate(item); saveState(); }
        function deleteItem(id) { const index = items.findIndex(i => i.id === id); if (index > -1) { items[index].element.remove(); items.splice(index, 1); selectedItem = null; syncDelete(id); saveState(); } }
        function updateCanvasBg(color) { canvas.style.backgroundColor = color; if (p2pHost) broadcast({ type: 'bg_change', color }); saveState(); }
        function applyLayout(type) { if (items.length === 0) return; const count = items.length; const canvasW = canvas.offsetWidth; const canvasH = canvas.offsetHeight; const layoutItem = (item, x, y, w, h) => { item.element.style.width = w + 'px'; item.element.style.height = h + 'px'; item.element.style.left = x + 'px'; item.element.style.top = y + 'px'; item.rotation = 0; item.element.style.transform = `rotate(0deg)`; syncUpdate(item); }; if (type === 'grid') { const cols = Math.ceil(Math.sqrt(count)); const rows = Math.ceil(count / cols); const cellW = canvasW / cols; const cellH = canvasH / rows; items.forEach((item, i) => layoutItem(item, (i % cols) * cellW + 5, Math.floor(i / cols) * cellH + 5, cellW - 10, cellH - 10)); } else if (type === 'columns') { const w = canvasW / count; items.forEach((item, i) => layoutItem(item, i * w + 5, 10, w - 10, canvasH - 20)); } else if (type === 'rows') { const h = canvasH / count; items.forEach((item, i) => layoutItem(item, 10, i * h + 5, canvasW - 20, h - 10)); } else if (type === 'scatter') { items.forEach(item => layoutItem(item, Math.random() * (canvasW - 200), Math.random() * (canvasH - 200), 200, 200)); } saveState(); }
        function openExportModal() { document.getElementById('exportModal').style.display = 'flex'; }
        function setExportQuality(scale, el) { exportScale = scale; document.querySelectorAll('.export-option').forEach(e => e.classList.remove('active')); el.classList.add('active'); }
        function executeSave() { document.getElementById('exportModal').style.display = 'none'; document.getElementById('loading-overlay').style.display = 'flex'; document.getElementById('loading-text').innerText = "Exportálás folyamatban..."; setTimeout(() => { saveCollageHighQuality(exportScale); document.getElementById('loading-overlay').style.display = 'none'; }, 500); }
        function saveCollageHighQuality(scale = 1) { const exportCanvas = document.createElement('canvas'); exportCanvas.width = canvas.offsetWidth * scale; exportCanvas.height = canvas.offsetHeight * scale; const ctx = exportCanvas.getContext('2d'); ctx.fillStyle = canvas.style.backgroundColor || '#ffffff'; ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height); const sortedItems = [...items].sort((a, b) => parseInt(a.element.style.zIndex) - parseInt(b.element.style.zIndex)); sortedItems.forEach(item => { const domImg = item.element.querySelector('img'); const dx = parseFloat(item.element.style.left) * scale; const dy = parseFloat(item.element.style.top) * scale; const dw = parseFloat(item.element.style.width) * scale; const dh = parseFloat(item.element.style.height) * scale; const rot = item.rotation || 0; ctx.save(); ctx.translate(dx + dw / 2, dy + dh / 2); ctx.rotate(rot * Math.PI / 180); ctx.drawImage(domImg, 0, 0, domImg.naturalWidth, domImg.naturalHeight, -dw / 2, -dh / 2, dw, dh); ctx.restore(); }); const link = document.createElement('a'); link.download = `AeroCollage_ProMAX_${scale}x_${Date.now()}.png`; link.href = exportCanvas.toDataURL('image/png', 1.0); link.click(); }
        function clearCollage() { if(confirm("Biztos törölsz mindent?")) { canvas.innerHTML = ''; items = []; zCounter = 1; if(p2pHost) broadcast({type: 'clear'}); saveState(); } }
        function showToast(msg) { const container = document.getElementById('toast-area'); const toast = document.createElement('div'); toast.className = 'toast'; toast.innerHTML = `<span class="material-icons">info</span> ${msg}`; container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000); }

        // --- P2P SYNC ---
        let peer, conn, p2pHost = false; let currentUser = null;
        function login() { currentUser = document.getElementById('username').value; if(!currentUser) return; document.getElementById('user-btn').innerText = currentUser; document.getElementById('loginModal').style.display = 'none'; }
        function openLoginModal() { document.getElementById('loginModal').style.display='flex'; }
        function startHost() { if(!currentUser) { openLoginModal(); return; } p2pHost = true; initPeer(document.getElementById('channel-select').value); }
        function joinGuest() { if(!currentUser) { openLoginModal(); return; } p2pHost = false; initPeer(null); }
        function initPeer(id) { peer = new Peer(id); peer.on('open', () => { document.getElementById('p2p-controls').style.display='none'; document.getElementById('p2p-status').style.display='block'; showToast("P2P kapcsolat: OK"); if(!p2pHost) { conn = peer.connect(document.getElementById('channel-select').value); setupConn(conn); conn.on('open', () => { conn.send({type: 'hello', username: currentUser}); showToast("Csatlakozva."); }); } }); peer.on('connection', (c) => { setupConn(c); setTimeout(() => items.forEach(i => c.send({type: 'create', id: i.id, src: i.src, x: parseFloat(i.element.style.left), y: parseFloat(i.element.style.top), w: parseFloat(i.element.style.width), h: parseFloat(i.element.style.height), z: parseInt(i.element.style.zIndex), rotation: i.rotation, originalSrc: i.originalSrc})), 1000); }); peer.on('error', (err) => alert("P2P Hiba: " + err.type)); }
        function setupConn(c) { c.on('data', (data) => { if(data.type === 'hello') showToast(`${data.username} csatlakozott!`); if(data.type === 'create') { if(!items.find(i => i.id === data.id)) createCollageItem(data.src, data); } else if(data.type === 'update') { const item = items.find(i => i.id === data.id); if(item) { item.element.style.left = data.x + 'px'; item.element.style.top = data.y + 'px'; item.element.style.width = data.w + 'px'; item.element.style.height = data.h + 'px'; item.element.style.zIndex = data.z; item.rotation = data.rotation; item.element.style.transform = `rotate(${data.rotation}deg)`; if(data.src && item.src !== data.src) { item.src = data.src; item.element.querySelector('img').src = data.src; } } } else if(data.type === 'delete') { deleteItem(data.id); } else if(data.type === 'bg_change') { canvas.style.backgroundColor = data.color; document.getElementById('canvas-bg').value = data.color; } else if(data.type === 'clear') { canvas.innerHTML = ''; items = []; zCounter=1; } else if(data.type === 'draw_start') { gifCtx.beginPath(); gifCtx.moveTo(data.x, data.y); gifCtx.strokeStyle = data.color; gifCtx.lineWidth = data.width; gifCtx.lineCap = 'round'; } else if(data.type === 'draw_move') { gifCtx.lineTo(data.x, data.y); gifCtx.stroke(); } else if(data.type === 'gif_next_frame') { executeNextFrame(); } else if(data.type === 'gif_clear') { gifCtx.clearRect(0, 0, 500, 500); gifCtx.fillStyle = 'white'; gifCtx.fillRect(0,0,500,500); } }); }
        function syncCreate(id, src, x, y, w, h, z, rotation, originalSrc) { if(peer) broadcast({ type: 'create', id, src, x, y, w, h, z, rotation, originalSrc }); }
        function syncUpdate(item) { if(peer) broadcast({ type: 'update', id: item.id, src: item.src, x: parseFloat(item.element.style.left), y: parseFloat(item.element.style.top), w: parseFloat(item.element.style.width), h: parseFloat(item.element.style.height), z: parseInt(item.element.style.zIndex), rotation: item.rotation }); }
        function syncDelete(id) { if(peer) broadcast({ type: 'delete', id }); }
        function broadcast(msg) { if(p2pHost) for(let conId in peer.connections) peer.connections[conId].forEach(c => c.send(msg)); else if(conn && conn.open) conn.send(msg); }
        function disconnectP2P() { if(peer) peer.destroy(); location.reload(); }

        // --- DRIVE ---
        const CLIENT_ID = '138100233309-v575n23j2b6pdek9t9clvkg3immlkrdi.apps.googleusercontent.com'; const API_KEY = 'AIzaSyAfC2viqoOsVVjcShnqY2rrRsxdV7WHMEg'; const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'; const SCOPES = 'https://www.googleapis.com/auth/drive.file'; let gapiInited=false, gisInited=false, tokenClient; function gapiLoaded(){gapi.load('client',async()=>{await gapi.client.init({apiKey:API_KEY,discoveryDocs:[DISCOVERY_DOC]});gapiInited=true;});} function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:(r)=>{}});gisInited=true;} async function handleDriveSave() { if(!currentUser) { alert("Jelentkezz be!"); return; } if(!gapiInited || !gisInited) return; tokenClient.callback = async (resp) => { if(resp.error) return; const loadingOverlay = document.getElementById('loading-overlay'); loadingOverlay.style.display='flex'; document.getElementById('loading-text').innerText="Feltöltés Drive-ra..."; const scale = 2; const exportCanvas = document.createElement('canvas'); exportCanvas.width = canvas.offsetWidth * scale; exportCanvas.height = canvas.offsetHeight * scale; const ctx = exportCanvas.getContext('2d'); ctx.fillStyle = canvas.style.backgroundColor || '#ffffff'; ctx.fillRect(0,0,exportCanvas.width,exportCanvas.height); [...items].sort((a,b)=>parseInt(a.element.style.zIndex)-parseInt(b.element.style.zIndex)).forEach(item=>{ const domImg = item.element.querySelector('img'); const dx = parseFloat(item.element.style.left)*scale, dy = parseFloat(item.element.style.top)*scale, dw = parseFloat(item.element.style.width)*scale, dh = parseFloat(item.element.style.height)*scale, rot = item.rotation || 0; ctx.save(); ctx.translate(dx + dw/2, dy + dh/2); ctx.rotate(rot * Math.PI / 180); ctx.drawImage(domImg, 0, 0, domImg.naturalWidth, domImg.naturalHeight, -dw/2, -dh/2, dw, dh); ctx.restore(); }); exportCanvas.toBlob(async blob => { const form = new FormData(); form.append('metadata', new Blob([JSON.stringify({'name':`AeroCollage_ProMAX_${Date.now()}.png`,'mimeType':'image/png'})],{type:'application/json'})); form.append('file', blob); await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method:'POST', headers: new Headers({'Authorization': 'Bearer '+gapi.client.getToken().access_token}), body: form }); loadingOverlay.style.display='none'; showToast("Drive mentés kész!"); }); }; tokenClient.requestAccessToken({prompt: ''}); }

        // --- UNDO / REDO ---
        const historyStack = []; const redoStack = []; const MAX_HISTORY = 30; setTimeout(saveState, 500);
        function saveState() { const state = { bg: canvas.style.backgroundColor, items: items.map(i => ({ id: i.id, src: i.src, x: parseFloat(i.element.style.left), y: parseFloat(i.element.style.top), w: parseFloat(i.element.style.width), h: parseFloat(i.element.style.height), z: parseInt(i.element.style.zIndex), rotation: i.rotation, originalSrc: i.originalSrc })) }; if(historyStack.length > 0) { const last = historyStack[historyStack.length - 1]; if(JSON.stringify(last) === JSON.stringify(state)) return; } historyStack.push(state); if (historyStack.length > MAX_HISTORY) historyStack.shift(); redoStack.length = 0; }
        function restoreFromState(state) { canvas.innerHTML = ''; items = []; canvas.style.backgroundColor = state.bg; document.getElementById('canvas-bg').value = state.bg || '#ffffff'; if(p2pHost) broadcast({ type: 'bg_change', color: state.bg }); if(p2pHost) broadcast({type: 'clear'}); let maxZ = 0; state.items.forEach(data => { createCollageItem(data.src, data); if(data.z > maxZ) maxZ = data.z; syncCreate(data.id, data.src, data.x, data.y, data.w, data.h, data.z, data.rotation, data.originalSrc); }); zCounter = maxZ + 1; }
        function undo() { if (historyStack.length <= 1) return; const currentState = historyStack.pop(); redoStack.push(currentState); const prevState = historyStack[historyStack.length - 1]; restoreFromState(prevState); showToast("Visszavonás"); }
        function redo() { if (redoStack.length === 0) return; const nextState = redoStack.pop(); historyStack.push(nextState); restoreFromState(nextState); showToast("Mégsem visszavonás"); }
        window.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z' && !e.shiftKey) { e.preventDefault(); undo(); } if ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 'y' || (e.shiftKey && e.key.toLowerCase() === 'z'))) { e.preventDefault(); redo(); } });


        // ==========================================
        // GIF STUDIO FUNKCIÓK (UI + LOGIKA)
        // ==========================================

        function openGifStudio() {
            document.getElementById('gif-studio').style.display = 'flex';
            // Alaphelyzetbe állítás ha üres
            if(gifFrames.length === 0) {
                gifCtx.fillStyle = 'white';
                gifCtx.fillRect(0,0,500,500);
            }
            updateGifFrameList();
        }

        function closeGifStudio() {
            document.getElementById('gif-studio').style.display = 'none';
        }

        function setGifColor(color, el) {
            isEraser = false;
            gifColor = color;
            
            // UI frissítés
            if(el) {
                document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
            }
            // Ha custom inputról jön, töröljük az aktív osztályt a swatchekról
            if(!el) document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('active'));

            // Reset brush button styles (ha eraser volt)
            document.querySelectorAll('.brush-btn').forEach(b => {
                if(b.title.includes("Radír")) b.classList.remove('active');
            });
        }

        function setGifTool(type, size, el) {
            document.querySelectorAll('.brush-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            
            // Slider szinkronizálása
            document.getElementById('brush-slider').value = size;

            if (type === 'eraser') {
                isEraser = true;
                gifColor = 'white'; // A radír valójában fehér
            } else {
                isEraser = false;
                // Visszaállítjuk a legutóbb választott színt (ha fehér volt, akkor feketére, vagy a paletta alapján)
                // Egyszerűsítés: ha nem radír, nézzük meg melyik szín aktív a UI-n
                const activeSwatch = document.querySelector('.color-swatch.active');
                if(activeSwatch) {
                    gifColor = activeSwatch.style.backgroundColor;
                } else {
                    const customInput = document.querySelector('.custom-color-input');
                    gifColor = customInput.value || 'black';
                }
            }
            gifLineWidth = size;
        }

        function updateBrushSlider(val) {
            gifLineWidth = parseInt(val);
            // Ha épp radír módban vagyunk, maradjon radír
        }

        function clearGifCanvas() {
            gifCtx.clearRect(0, 0, 500, 500);
            gifCtx.fillStyle = 'white';
            gifCtx.fillRect(0,0,500,500);
            broadcast({ type: 'gif_clear' });
        }

        // Rajzolás logika
        function getGifCoords(e) {
            const rect = gifCanvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        gifCanvas.addEventListener('mousedown', (e) => {
            isGifDrawing = true;
            lastGifPos = getGifCoords(e);
            gifCtx.beginPath();
            gifCtx.moveTo(lastGifPos.x, lastGifPos.y);
            gifCtx.strokeStyle = gifColor;
            gifCtx.lineWidth = gifLineWidth;
            gifCtx.lineCap = 'round';
            broadcast({ type: 'draw_start', x: lastGifPos.x, y: lastGifPos.y, color: gifColor, width: gifLineWidth });
        });

        gifCanvas.addEventListener('mousemove', (e) => {
            if (!isGifDrawing) return;
            const pos = getGifCoords(e);
            gifCtx.lineTo(pos.x, pos.y);
            gifCtx.stroke();
            broadcast({ type: 'draw_move', x: pos.x, y: pos.y });
            lastGifPos = pos;
        });

        gifCanvas.addEventListener('mouseup', () => { isGifDrawing = false; });
        gifCanvas.addEventListener('mouseleave', () => { isGifDrawing = false; });

        function nextGifFrame() { executeNextFrame(); broadcast({ type: 'gif_next_frame' }); }

        function executeNextFrame() {
            const currentFrameData = gifCanvas.toDataURL('image/png');
            gifFrames.push(currentFrameData);
            document.getElementById('gif-onion-skin').src = currentFrameData;
            
            gifCtx.clearRect(0, 0, 500, 500);
            gifCtx.fillStyle = 'white';
            gifCtx.fillRect(0,0,500,500);

            document.getElementById('frame-counter').innerText = `Kocka: ${gifFrames.length + 1}`;
            updateGifFrameList();
            showToast("Következő réteg aktív!");
        }

        function updateGifFrameList() {
            const container = document.getElementById('gif-frames-container');
            container.innerHTML = '';
            gifFrames.forEach((src, idx) => {
                const div = document.createElement('div');
                div.className = 'gif-frame-thumb';
                div.style.backgroundImage = `url(${src})`;
                div.style.backgroundSize = 'contain';
                container.appendChild(div);
            });
            const currentDiv = document.createElement('div');
            currentDiv.className = 'gif-frame-thumb active';
            currentDiv.innerText = `${gifFrames.length+1}`;
            currentDiv.style.display='flex'; currentDiv.style.alignItems='center'; currentDiv.style.justifyContent='center'; currentDiv.style.color='#333'; currentDiv.style.fontWeight='bold';
            container.appendChild(currentDiv);
            // Scroll to end
            container.scrollLeft = container.scrollWidth;
        }

        function finishAndExportGif() {
            if (gifFrames.length === 0) { gifFrames.push(gifCanvas.toDataURL('image/png')); } 
            else { gifFrames.push(gifCanvas.toDataURL('image/png')); }

            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            document.getElementById('loading-text').innerText = "GIF Generálása...";

            const workerBlob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');`], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);

            const gif = new GIF({ workers: 2, quality: 10, width: 500, height: 500, workerScript: workerUrl });
            let loadedImages = 0;
            gifFrames.forEach(src => {
                const img = new Image(); img.src = src;
                img.onload = () => {
                    gif.addFrame(img, {delay: 200});
                    loadedImages++;
                    if (loadedImages === gifFrames.length) {
                        gif.on('finished', function(blob) {
                            loadingOverlay.style.display = 'none';
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url; link.download = `AeroCollage_Animation_${Date.now()}.gif`; link.click();
                            gifFrames.pop(); 
                        });
                        gif.render();
                    }
                };
            });
        }
    </script>
</body>
</html>
