<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroCode PRO v16.0 - Knowledge Base Edition</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            /* --- T√âMA DEFIN√çCI√ìK --- */
            --bg-color: #050505;
            --side-panel-bg: #0a0a0a;
            --text-color: #e0e0e0;
            --border-color: #333333;
            --accent-color: #00E676; /* Hacker Green accent */
            --accent-secondary: #2196F3;
            --output-bg: #111;
            
            /* √úVEG HAT√ÅS */
            --glass-bg: rgba(10, 10, 10, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.7);
            --glass-blur: 12px;
            
            --modal-bg: #141414;
            --input-field-bg: #1f1f1f;
            
            --btn-hover: rgba(255, 255, 255, 0.1);
            --run-color: #00E676;
            --run-glow: rgba(0, 230, 118, 0.4);

            --hint-bg: #252526;
            --hint-text: #e0e0e0;
            --hint-select-bg: #004d2a;
            --hint-select-text: #ffffff;
            
            --system-msg-color: #888;
            --p2p-msg-color: #ffab40;
            
            --panel-width: 380px;
            
            /* SCROLLBAR */
            --scrollbar-width: 8px;
            --scrollbar-track: #000;
            --scrollbar-thumb: #444;
            --scrollbar-thumb-hover: #666;
        }

        body.light-mode {
            --bg-color: #f5f5f7;
            --side-panel-bg: #ffffff;
            --text-color: #333333;
            --border-color: #d1d1d1;
            --output-bg: #ffffff;
            --accent-color: #1976D2; 
            --accent-secondary: #00E676;
            
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --glass-blur: 15px;

            --modal-bg: #ffffff;
            --input-field-bg: #e6e6e6;
            --btn-hover: rgba(0, 0, 0, 0.05);
            --run-color: #1976D2;
            --run-glow: rgba(25, 118, 210, 0.4);

            --hint-bg: #f3f3f3;
            --hint-text: #333333;
            --hint-select-bg: #b4d7ff;
            --hint-select-text: #000000;
            
            --scrollbar-track: #f0f0f0;
            --scrollbar-thumb: #ccc;
            --scrollbar-thumb-hover: #bbb;
        }

        * { box-sizing: border-box; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: var(--scrollbar-width); height: var(--scrollbar-width); }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }

        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background 0.3s ease;
            user-select: none;
        }
        
        /* MATRIX CANVAS */
        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.3; pointer-events: none;
        }

        /* --- CODE MIRROR --- */
        .CodeMirror { 
            flex: 1; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 14px; 
            background-color: transparent !important; 
            height: 100%; 
            position: relative;
            color: #f8f8f2;
            z-index: 1; 
            user-select: text; 
            line-height: 1.6;
        }
        .CodeMirror-gutters { 
            background-color: var(--bg-color) !important;
            border-right: 1px solid var(--border-color); 
        }
        .CodeMirror-linenumber { color: #555; }
        .CodeMirror-cursor { border-left: 2px solid var(--accent-color) !important; }
        
        /* Hint Styles */
        .CodeMirror-hints {
            position: absolute; z-index: 100000; overflow: hidden; list-style: none; margin: 0; padding: 2px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.6); border-radius: 6px; border: 1px solid var(--border-color);
            background: var(--hint-bg); font-family: 'JetBrains Mono', monospace; font-size: 13px; max-height: 250px; overflow-y: auto;
        }
        .CodeMirror-hint { 
            margin: 0; padding: 5px 10px; border-radius: 3px; white-space: pre; color: var(--hint-text); cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        li.CodeMirror-hint-active { background: var(--hint-select-bg); color: var(--hint-select-text); }
        
        /* UI HEADER */
        .header-wrapper {
            position: fixed; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 30px;
            z-index: 2000; pointer-events: none; 
        }

        .glass-bubble {
            pointer-events: auto; 
            background: var(--glass-bg); 
            backdrop-filter: blur(var(--glass-blur)); 
            border: 1px solid var(--glass-border); 
            box-shadow: var(--glass-shadow); 
            border-radius: 12px; 
            padding: 8px 12px;
            display: flex; align-items: center; gap: 10px; 
            transition: all 0.3s ease;
        }
        .glass-bubble:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-color: var(--accent-color); }

        .app-title { font-weight: 800; font-size: 15px; padding: 0 10px; letter-spacing: 0.5px; color: var(--text-color); display: flex; align-items: center; gap: 8px; }
        .vertical-divider { width: 1px; height: 24px; background-color: var(--border-color); margin: 0 5px; }

        button.icon-btn { background: transparent; border: none; color: var(--text-color); width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; position: relative;}
        button.icon-btn:hover { background: var(--btn-hover); color: var(--accent-color); }

        button.run-btn { background: var(--run-color); color: #000; border: none; width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 2px; box-shadow: 0 0 15px var(--run-glow); transition: all 0.2s; font-weight: bold;}
        button.run-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--run-glow); filter: brightness(1.2); }

        #user-btn { cursor: pointer; font-size:12px; opacity:0.9; margin-right:5px; padding: 6px 14px; border-radius: 6px; background: var(--btn-hover); transition: background 0.2s; font-weight:600; letter-spacing:0.5px; }
        #user-btn:hover { background: var(--accent-color); color: #000; }

        /* DROPDOWN */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            opacity: 0; visibility: hidden; position: absolute; right: 0; top: 50px;
            background-color: #1a1a1a;
            min-width: 300px; box-shadow: 0px 10px 40px rgba(0,0,0,0.8);
            border-radius: 12px; border: 1px solid var(--border-color);
            z-index: 3000; overflow: hidden;
            transition: all 0.2s cubic-bezier(0.165, 0.84, 0.44, 1); transform: translateY(-10px) scale(0.98);
            padding: 8px; cursor: default;
        }
        .dropdown:hover .dropdown-content { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
        .menu-item {
            color: var(--text-color); padding: 10px 14px; text-decoration: none;
            display: flex; align-items: center; gap: 12px; font-size: 13px;
            transition: background 0.2s; cursor: pointer; border-radius: 6px;
        }
        .menu-item:hover { background-color: var(--btn-hover); color: var(--accent-color); }

        /* LAYOUT */
        .main-container { display: flex; height: 100vh; width: 100%; position: relative; overflow: hidden; padding-top: 0; }
        .editor-container { 
            flex: 1; display: flex; flex-direction: column; 
            background: rgba(0,0,0,0.2); min-width: 0; position: relative; z-index: 1;
            backdrop-filter: blur(5px);
        }
        .CodeMirror-scroll { padding-top: 90px; padding-bottom: 50px; }
        
        /* SIDE PANEL */
        .side-panel { 
            position: fixed; top: 0; right: 0; bottom: 0;
            width: var(--panel-width);
            background-color: var(--side-panel-bg); 
            border-left: 1px solid var(--border-color);
            padding-top: 90px; display: flex; flex-direction: column;
            z-index: 1500; transform: translateX(100%); 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        .side-panel.open { transform: translateX(0); }
        
        #panel-close-btn {
            position: absolute; left: 0; top: 50%; transform: translateY(-50%) translateX(-100%); 
            width: 24px; height: 60px; background: var(--side-panel-bg);
            border: 1px solid var(--border-color); border-right: none;
            border-radius: 8px 0 0 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-color); z-index: 1501; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .side-panel.open #panel-close-btn { opacity: 1; pointer-events: auto; }
        #panel-close-btn:hover { color: var(--accent-color); }

        #panel-trigger { position: fixed; top: 0; right: 0; bottom: 0; width: 20px; z-index: 1400; }

        .panel-header { padding: 10px 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.5; margin-bottom: 5px; color: var(--accent-color); }
        
        /* TERMINAL & CHAT */
        .terminal-wrapper { 
            flex: 2; display: flex; flex-direction: column; 
            background-color: var(--output-bg); border-radius: 8px; 
            margin: 0 20px 20px 20px; overflow: hidden; 
            border: 1px solid var(--border-color);
        }
        .avatar-panel-wrapper {
            flex: 0 0 auto; min-height: 90px; background-color: var(--output-bg); border-radius: 8px;
            margin: 0 20px 20px 20px; border: 1px solid var(--border-color);
            padding: 10px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center;
        }
        .avatar-circle {
            width: 36px; height: 36px; border-radius: 50%; border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: #000; font-size: 13px;
        }
        .chat-wrapper {
            flex: 2; display: flex; flex-direction: column;
            background-color: var(--output-bg); border-radius: 8px;
            margin: 0 20px 20px 20px; overflow: hidden; border: 1px solid var(--border-color); position: relative;
        }

        #output { flex: 1; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 13px; white-space: pre-wrap; overflow-y: auto; color: var(--text-color); }
        
        /* LOADING */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 9998; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .loader-ring { display: inline-block; position: relative; width: 80px; height: 80px; }
        .loader-ring div { box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; border: 4px solid var(--accent-color); border-radius: 50%; animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: var(--accent-color) transparent transparent transparent; }
        .loader-ring div:nth-child(1) { animation-delay: -0.45s; }
        .loader-ring div:nth-child(2) { animation-delay: -0.3s; }
        .loader-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes loader-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; backdrop-filter: blur(10px); justify-content: center; align-items: center; }
        .modal { background: var(--modal-bg); width: 600px; max-width: 90%; max-height: 85vh; padding: 0; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8); display: flex; flex-direction: column; overflow: hidden; }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); }
        .modal-header h3 { margin: 0; font-size: 18px; color: var(--text-color); display: flex; align-items: center; gap: 10px; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); text-align: right; background: rgba(0,0,0,0.2); }
        
        .modal input[type="text"], .modal input[type="password"], .modal select { width: 100%; padding: 12px; background: var(--input-field-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 6px; margin-bottom: 10px; font-family: 'Inter'; outline: none; transition: border 0.2s; }
        .modal input:focus { border-color: var(--accent-color); }
        
        .modal button.primary { background: var(--accent-color); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .modal button.secondary { background: transparent; color: var(--text-color); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 10px; }
        .modal button:hover { opacity: 0.9; }

        /* --- DOCS SEARCH STYLES --- */
        #docSearch {
            width: 100%; padding: 14px; background: #000; border: 2px solid var(--border-color);
            color: var(--accent-color); font-family: 'JetBrains Mono'; font-size: 14px; border-radius: 8px;
            margin-bottom: 20px; outline: none;
        }
        #docSearch:focus { border-color: var(--accent-color); box-shadow: 0 0 15px rgba(0, 230, 118, 0.1); }
        
        #docResults { display: flex; flex-direction: column; gap: 15px; }
        
        .doc-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; transition: transform 0.2s;
        }
        .doc-card:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); border-left: 3px solid var(--accent-color); }
        
        .doc-card-title { font-weight: bold; color: var(--accent-color); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .doc-card-match-score { font-size: 10px; opacity: 0.5; font-family: monospace; border: 1px solid #444; padding: 2px 4px; border-radius: 4px; }
        .doc-card-desc { font-size: 13px; color: #ccc; margin-bottom: 10px; line-height: 1.4; }
        
        .code-block {
            background: #111; padding: 10px; border-radius: 4px; border: 1px solid #333;
            font-family: 'JetBrains Mono'; font-size: 12px; color: #a9b7c6; overflow-x: auto;
            position: relative;
        }
        /* Syntax highlighting simple simulation for docs */
        .kw { color: #cc7832; font-weight: bold; } /* keyword */
        .str { color: #6a8759; } /* string */
        .num { color: #6897bb; } /* number */
        .func { color: #ffc66d; } /* function */
        .cmt { color: #808080; font-style: italic; } /* comment */
        
        .copy-btn-mini {
            position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.1); border: none; color: #fff;
            padding: 4px; border-radius: 4px; cursor: pointer; font-size: 10px; opacity: 0.5;
        }
        .copy-btn-mini:hover { opacity: 1; background: var(--accent-color); color: #000; }

        /* Dynamic classes */
        .system-msg { color: #888; font-style: italic; }
        .error { color: #ff5555; }
        .p2p-msg { color: var(--p2p-msg-color); }
        
    </style>
</head>
<body>

    <canvas id="matrix-canvas"></canvas>

    <div id="loading-overlay">
        <div class="loader-ring"><div></div><div></div><div></div><div></div></div>
        <div style="margin-top:20px; color:#fff; font-family:'JetBrains Mono'">Rendszer inicializ√°l√°sa...</div>
    </div>

    <div id="panel-trigger"></div>
    <div id="tutorial-toast"></div>
    <div id="avatar-popup" class="avatar-popup-menu"></div>

    <div class="header-wrapper">
        <div class="glass-bubble left-bubble">
            <div class="app-title">
                <span class="material-icons" style="color:var(--accent-color)">code</span>
                AeroCode <span style="font-weight:400; opacity:0.7">PRO</span>
            </div>
            <div class="vertical-divider"></div>
            <button class="run-btn" onclick="runPython()" title="Futtat√°s (Ctrl+Enter)">
                <span class="material-icons">play_arrow</span>
            </button>
        </div>

        <div class="glass-bubble right-bubble">
            <div id="user-btn" onclick="openLoginModal()">Bel√©p√©s</div>
            
            <div class="dropdown">
                <button class="icon-btn" title="K√∂z√∂s Munka (P2P)">
                    <span class="material-icons">group</span>
                </button>
                <div class="dropdown-content">
                    <h4 style="margin:0 0 10px 0; border-bottom:1px solid #333; padding-bottom:10px; color:var(--text-color)">K√∂z√∂s Munka (P2P)</h4>
                    <div id="connect-ui">
                        <select id="channel-select" style="width:100%; padding:8px; background:var(--input-field-bg); border:1px solid var(--border-color); color:var(--text-color); border-radius:6px; margin-bottom:10px;">
                            <option value="1">1. Csatorna (Alpha)</option>
                            <option value="2">2. Csatorna (Beta)</option>
                            <option value="3">3. Csatorna (Gamma)</option>
                            <option value="random">Egyedi Szoba (Priv√°t)</option>
                        </select>
                        
                        <div id="custom-code-ui" style="display:none; margin-bottom:10px; background:#111; padding:10px; border-radius:6px;">
                             <label style="font-size:11px; color:#888;">Gener√°lt K√≥d (K√ºldd el!):</label>
                             <input type="text" id="generated-room-id" readonly style="width:100%; color:var(--accent-color); font-weight:bold; text-align:center; border:none; background:transparent;">
                             <label style="font-size:11px; color:#888; margin-top:5px; display:block;">Vagy √≠rd be a kapott k√≥dot:</label>
                             <input type="text" id="input-room-id" placeholder="Szoba k√≥d..." style="width:100%;">
                        </div>

                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button onclick="startAsHost()" style="flex:1; padding:8px; background:var(--accent-color); color:#000; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">HOST</button>
                            <button onclick="joinAsGuest()" style="flex:1; padding:8px; background:#2196F3; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">JOIN</button>
                        </div>
                    </div>
                    <div id="disconnect-ui" style="display:none;">
                        <div style="background:rgba(0, 230, 118, 0.1); color:#00E676; padding:8px; border-radius:6px; margin-bottom:10px; text-align:center; font-size:12px;">
                            <span class="material-icons" style="font-size:12px; vertical-align:middle;">wifi</span> Kapcsol√≥dva
                        </div>
                        <div id="active-users-list" style="margin-bottom:10px;"></div>
                        <button onclick="disconnectPeer()" style="width:100%; padding:8px; background:#ff5555; color:white; border:none; border-radius:6px; cursor:pointer;">Kil√©p√©s</button>
                    </div>
                    <div id="p2p-log" style="font-size:10px; color:#666; margin-top:8px; text-align:center;">Offline</div>
                </div>
            </div>

            <button class="icon-btn" onclick="askGemini()" title="Gemini AI Asszisztens"><span class="material-icons">auto_awesome</span></button>
            <button class="icon-btn" onclick="openDocs()" title="Tud√°sb√°zis & Puska"><span class="material-icons">school</span></button>
            <button class="icon-btn" onclick="toggleTheme()" title="T√©ma"><span class="material-icons">contrast</span></button>
            <button class="icon-btn" onclick="downloadCode()" title="Ment√©s"><span class="material-icons">save_alt</span></button>
            <button class="icon-btn" onclick="openSettings()" title="Be√°ll√≠t√°sok"><span class="material-icons">settings</span></button>
        </div>
    </div>

    <div class="main-container">
        <div class="editor-container">
            <textarea id="code-editor">
# AeroCode PRO v16.0
# Tud√°sb√°zis Edition
#
# Kattints a üéì (Sapka) ikonra a jobb fels≈ë sarokban!
# Ott tal√°lod az √∫j keres≈ët, ahol be√≠rhatsz b√°rmit,
# p√©ld√°ul: "sz√∂veg megford√≠t√°sa" vagy "karakter csere".

def udvozles(nev):
    print(f"Szia, {nev}!")
    print("A rendszer k√©szen √°ll.")

udvozles("Felhaszn√°l√≥")
            </textarea>
        </div>

        <div class="side-panel" id="sidePanel">
            <div id="panel-close-btn" onclick="closeSidePanel()"><span class="material-icons">chevron_right</span></div>

            <div class="panel-header">Kimenet</div>
            <div class="terminal-wrapper">
                <div id="output"></div>
                <div id="terminal-input-bar" style="display:none; padding:10px; background:#111; border-top:1px solid #333; display:flex;">
                    <span style="color:var(--accent-color); margin-right:5px;">&gt;</span>
                    <input type="text" id="term-input" style="flex:1; background:transparent; border:none; color:#fff; font-family:'JetBrains Mono'; outline:none;" autocomplete="off">
                </div>
            </div>
            
            <div class="panel-header">Csapat</div>
            <div id="avatar-panel" class="avatar-panel-wrapper">
                <div style="font-size:12px; color:#666;">Nincs akt√≠v kapcsolat.</div>
            </div>

            <div class="panel-header">Chat</div>
            <div class="chat-wrapper">
                <div id="chat-history"></div>
                <div id="chat-input-bar">
                    <input type="text" id="chat-input" placeholder="√çrj √ºzenetet..." autocomplete="off">
                </div>
            </div>
        </div>
    </div>

    <div id="docsModal" class="modal-overlay">
        <div class="modal" style="width:800px; height:80vh;">
            <div class="modal-header">
                <h3><span class="material-icons" style="color:var(--accent-color)">school</span> Tud√°sb√°zis & Puska</h3>
                <button onclick="document.getElementById('docsModal').style.display='none'" style="background:transparent; border:none; color:#666; cursor:pointer;"><span class="material-icons">close</span></button>
            </div>
            <div class="modal-body" style="background: #0e0e0e;">
                <input type="text" id="docSearch" placeholder="Keres√©s... (Pl.: 'sz√∂veg megford√≠t√°sa', 'ciklus', 'f√°jl olvas√°s')" onkeyup="searchDocs()">
                
                <div id="docResults">
                    <div style="text-align:center; color:#666; margin-top:50px;">
                        <span class="material-icons" style="font-size:48px; opacity:0.2">search</span><br>
                        √çrj be valamit a keres≈ëbe a tal√°latokhoz!<br>
                        <span style="font-size:12px; opacity:0.5">Pr√≥b√°ld: "lista", "reverse", "replace", "if"</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Be√°ll√≠t√°sok</h3>
            </div>
            <div class="modal-body">
                <label>Gemini API Kulcs</label>
                <input type="password" id="apiKeyInput" placeholder="API Key...">
                
                <label>H√°tt√©r Effekt</label>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                    <input type="checkbox" id="matrixEffectToggle" checked onchange="toggleMatrix()">
                    <span style="font-size:13px; color:#aaa;">M√°trix es≈ë effekt enged√©lyez√©se</span>
                </div>

                <label>Bet≈±m√©ret (px)</label>
                <input type="number" id="fontSizeInput" value="14" min="10" max="30">
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="document.getElementById('settingsModal').style.display='none'">M√©gse</button>
                <button class="primary" onclick="saveSettings()">Ment√©s</button>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal" style="width:400px; height:auto;">
            <div class="modal-header">
                <h3>Bel√©p√©s</h3>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:#888; margin-bottom:15px;">A k√∂z√∂s munk√°hoz (P2P) √©s a ment√©shez sz√ºks√©ges egy felhaszn√°l√≥n√©v.</p>
                <input type="text" id="loginNameInput" placeholder="Felhaszn√°l√≥n√©v...">
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="document.getElementById('loginModal').style.display='none'">M√©gse</button>
                <button class="primary" onclick="performLogin()">Bel√©p√©s</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. MATRIX BACKGROUND EFFECT ---
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        let matrixInterval;
        let matrixEnabled = true;

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = '„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums = '0123456789';
        const alphabet = katakana + latin + nums;

        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const rainDrops = [];

        for( let x = 0; x < columns; x++ ) { rainDrops[x] = 1; }

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#0F0'; // Green text
            ctx.font = fontSize + 'px monospace';

            for(let i = 0; i < rainDrops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                // Randomly brighter characters
                ctx.fillStyle = Math.random() > 0.95 ? '#FFF' : '#00E676';
                ctx.fillText(text, i*fontSize, rainDrops[i]*fontSize);

                if(rainDrops[i]*fontSize > canvas.height && Math.random() > 0.975){
                    rainDrops[i] = 0;
                }
                rainDrops[i]++;
            }
        }

        function startMatrix() {
            if(matrixInterval) clearInterval(matrixInterval);
            matrixInterval = setInterval(drawMatrix, 30);
        }
        function stopMatrix() {
            if(matrixInterval) clearInterval(matrixInterval);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        function toggleMatrix() {
            matrixEnabled = document.getElementById('matrixEffectToggle').checked;
            if(matrixEnabled) startMatrix(); else stopMatrix();
        }
        
        window.addEventListener('resize', () => { 
            canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
        });
        startMatrix(); // Init


        // --- 1. GLOBAL VARIABLES & INIT ---
        const outputElement = document.getElementById("output");
        let currentUser = null;
        let isSuperUser = false;
        
        // --- 2. EDITOR SETUP ---
        // Custom Autocomplete keywords defined later in DOC_DATABASE logic
        let editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: {name: "python", version: 3}, 
            theme: "dracula",
            lineNumbers: true, 
            indentUnit: 4, 
            smartIndent: true, 
            matchBrackets: true, 
            autoCloseBrackets: true,
            extraKeys: { 
                "Ctrl-Space": "autocomplete", 
                "Ctrl-Enter": function() { runPython(); } 
            },
            hintOptions: { completeSingle: false }, 
            lineWrapping: false,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
        });

        // --- 3. DOCUMENTATION DATABASE (THE BRAIN) ---
        // This is a large database for the search engine.
        const DOC_DATABASE = [
            {
                title: "Sz√∂veg Megford√≠t√°sa (Reverse)",
                keywords: "string ford√≠t√°s visszafel√© reverse megford√≠t bet≈±k t√ºkr√∂z√©s slice szeletel√©s",
                code: `szoveg = "Almafa"\n\n# Slicing m√≥dszer [kezd:v√©g:l√©p√©s]\n# A -1 l√©p√©s visszafel√© halad\nforditott = szoveg[::-1]\n\nprint(forditott) # afamlA`,
                desc: "Pythonban a legegyszer≈±bb m√≥dja egy string megford√≠t√°s√°nak a slicing (szeletel√©s). Nem kell hozz√° k√ºl√∂n f√ºggv√©ny."
            },
            {
                title: "Karakterek Cser√©je (Replace)",
                keywords: "string csere replace bet≈± karakter m√≥dos√≠t√°s kicser√©l",
                code: `szoveg = "Szeretem a tejet."\n\n# replace(mit, mire)\nuj_szoveg = szoveg.replace("tejet", "k√°v√©t")\n\nprint(uj_szoveg)\n# Kicser√©li az √ñSSZES el≈ëfordul√°st!`,
                desc: "A stringek Pythonban megv√°ltoztathatatlanok (immutable). A replace() egy √öJ stringet ad vissza."
            },
            {
                title: "Karakter Csere (Manu√°lis / Index)",
                keywords: "csere index szerint manu√°lis bet≈± csere adott poz√≠ci√≥",
                code: `szo = "K√∂rte"\n\n# A 2. karakter (r) cser√©je 'l'-re\n# Mivel string nem m√≥dos√≠that√≥, √∫jat rakunk √∂ssze:\n\nuj_szo = szo[:2] + 'l' + szo[3:]\nprint(uj_szo) # K√∂lte`,
                desc: "Ha index alapj√°n akarsz cser√©lni, sz√©t kell v√°gni a stringet az index el≈ëtt √©s ut√°n, majd √∂sszef≈±zni az √∫j karakterrel."
            },
            {
                title: "Lista Elemek Hozz√°ad√°sa (Append)",
                keywords: "lista list append hozz√°ad elem besz√∫r v√©g√©re",
                code: `gyumolcsok = ["alma", "k√∂rte"]\n\ngyumolcsok.append("szilva")\nprint(gyumolcsok)`,
                desc: "Az append() met√≥dus mindig a lista V√âG√âRE teszi az √∫j elemet."
            },
            {
                title: "Lista Elem T√∂rl√©se (Pop, Remove)",
                keywords: "lista t√∂rl√©s remove pop elem kiv√©tel delete",
                code: `szamok = [10, 20, 30, 40]\n\n# Index alapj√°n (kiveszi √©s visszaadja)\nkivett = szamok.pop(1) # 20-at veszi ki\n\n# √ârt√©k alapj√°n (csak az els≈ët t√∂rli)\nszamok.remove(40)\n\nprint(szamok)`,
                desc: "A pop() indexet v√°r (ha √ºres, az utols√≥t veszi el), a remove() pedig konkr√©t √©rt√©ket keres."
            },
            {
                title: "Ciklus (For Loop)",
                keywords: "for ciklus loop iter√°ci√≥ bej√°r√°s range",
                code: `nev = "Bela"\n\n# Bet≈±k√∂n v√©gigmenni\nfor betu in nev:\n    print(betu)\n\n# Sz√°msor (0-t√≥l 4-ig)\nfor i in range(5):\n    print(i)`,
                desc: "A for ciklus el≈ëre meghat√°rozott elemeken (vagy tartom√°nyon) megy v√©gig."
            },
            {
                title: "Felt√©tel (If Else)",
                keywords: "if else elif felt√©tel el√°gaz√°s kond√≠ci√≥ ha",
                code: `kor = 18\n\nif kor >= 18:\n    print("Feln≈ëtt")\nelif kor >= 14:\n    print("Tin√©dzser")\nelse:\n    print("Gyerek")`,
                desc: "Figyelj a beh√∫z√°sokra (indentation)! A Pythonban ez jelzi a blokkokat."
            },
            {
                title: "Sz√∂veg Darabol√°s (Split)",
                keywords: "split darabol√°s v√°g√°s lista stringb≈ël sz√≥k√∂z",
                code: `mondat = "Ez egy p√©lda mondat"\n\n# Sz√≥k√∂z√∂k ment√©n darabol\nszavak = mondat.split()\nprint(szavak)\n# ['Ez', 'egy', 'p√©lda', 'mondat']\n\n# Vessz≈ë ment√©n\nadat = "alma,k√∂rte,barack"\nlista = adat.split(",")`,
                desc: "A split() egy list√°t ad vissza. Ha nem adsz meg param√©tert, a sz√≥k√∂z√∂kn√©l v√°g."
            },
            {
                title: "Lista Sz√∂vegg√© (Join)",
                keywords: "join √∂sszef≈±z√©s lista stringg√© egyes√≠t√©s",
                code: `szavak = ['Szeretem', 'a', 'programoz√°st']\n\n# Sz√≥k√∂z legyen k√∂zt√ºk\nmondat = " ".join(szavak)\nprint(mondat)`,
                desc: "A join() a split() ellent√©te. A string, amin h√≠vod, lesz az elv√°laszt√≥."
            },
            {
                title: "F√ºggv√©nyek (Def)",
                keywords: "def f√ºggv√©ny function elj√°r√°s return visszat√©r√©s",
                code: `def osszead(a, b):\n    return a + b\n\neredmeny = osszead(5, 3)\nprint(eredmeny)`,
                desc: "A f√ºggv√©nyek √∫jrafelhaszn√°lhat√≥ k√≥dr√©szletek. A return kulcssz√≥ adja vissza az √©rt√©ket."
            },
            {
                title: "Try-Except (Hibakezel√©s)",
                keywords: "hiba try except error catch kiv√©tel hibakezel√©s",
                code: `try:\n    szam = int(input("Adj meg egy sz√°mot: "))\n    print(10 / szam)\nexcept ValueError:\n    print("Ez nem sz√°m!")\nexcept ZeroDivisionError:\n    print("Null√°val nem osztunk!")`,
                desc: "A program nem √°ll le hiba eset√©n, ha try-except blokkba teszed a vesz√©lyes k√≥dot."
            },
            {
                title: "V√©letlensz√°m (Random)",
                keywords: "random v√©letlen sorsol√°s choice randint shuffle",
                code: `import random\n\n# V√©letlen eg√©sz 1 √©s 10 k√∂z√∂tt\nprint(random.randint(1, 10))\n\n# V√©letlen v√°laszt√°s list√°b√≥l\nlista = ["k≈ë", "pap√≠r", "oll√≥"]\nprint(random.choice(lista))`,
                desc: "Haszn√°lat el≈ëtt import√°lni kell a random modult!"
            },
            {
                title: "F√°jl √≠r√°sa",
                keywords: "f√°jl file write √≠r√°s open with",
                code: `with open("adat.txt", "w", encoding="utf-8") as f:\n    f.write("Ez egy sor.\\n")\n    f.write("Ez a m√°sodik sor.")`,
                desc: "A 'w' m√≥d fel√ºl√≠rja a f√°jlt. Haszn√°lj 'a' m√≥dot a hozz√°f≈±z√©shez (append). A 'with' gondoskodik a bez√°r√°sr√≥l."
            }
        ];

        // --- 4. SMART SEARCH LOGIC ---
        function openDocs() {
            document.getElementById('docsModal').style.display = 'flex';
            document.getElementById('docSearch').focus();
            searchDocs(); // Show all or popular initially
        }

        function searchDocs() {
            const input = document.getElementById('docSearch').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('docResults');
            resultsContainer.innerHTML = "";

            if (input.length === 0) {
                // Show some defaults if empty
                renderResults(DOC_DATABASE.slice(0, 5), resultsContainer); // Show first few as featured
                return;
            }

            const searchTokens = input.split(" ");
            
            // Calculate scores
            const scoredResults = DOC_DATABASE.map(entry => {
                let score = 0;
                const content = (entry.title + " " + entry.keywords + " " + entry.desc).toLowerCase();
                
                searchTokens.forEach(token => {
                    if (entry.title.toLowerCase().includes(token)) score += 10; // Title match high value
                    else if (entry.keywords.includes(token)) score += 5;       // Keyword match medium
                    else if (entry.desc.toLowerCase().includes(token)) score += 1; // Desc match low
                });

                return { ...entry, score: score };
            });

            // Filter matches (score > 0) and Sort
            const matches = scoredResults.filter(r => r.score > 0).sort((a, b) => b.score - a.score);

            if (matches.length === 0) {
                resultsContainer.innerHTML = `<div style="text-align:center; padding:20px; color:#666;">Nincs tal√°lat. Pr√≥b√°lj m√°s kulcsszavakat!</div>`;
            } else {
                renderResults(matches, resultsContainer);
            }
        }

        function renderResults(list, container) {
            list.forEach(item => {
                const card = document.createElement('div');
                card.className = "doc-card";
                
                // Syntax Highlight Simulation
                let formattedCode = item.code
                    .replace(/#.*/g, match => `<span class="cmt">${match}</span>`)
                    .replace(/\b(def|class|return|if|else|elif|for|while|try|except|import|from|with|as)\b/g, '<span class="kw">$1</span>')
                    .replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, '<span class="str">$&</span>')
                    .replace(/\b(print|input|len|range|int|str|float|list|dict|set|open)\b/g, '<span class="func">$1</span>')
                    .replace(/\b\d+\b/g, '<span class="num">$&</span>');

                card.innerHTML = `
                    <div class="doc-card-title">
                        ${item.title}
                        ${item.score ? `<span class="doc-card-match-score">Relevancia: ${item.score}</span>` : ''}
                    </div>
                    <div class="doc-card-desc">${item.desc}</div>
                    <div class="code-block">
                        <button class="copy-btn-mini" onclick="copyToClipboard(this)">M√°sol√°s</button>
                        <pre>${formattedCode}</pre>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function copyToClipboard(btn) {
            const codeBlock = btn.nextElementSibling.innerText;
            navigator.clipboard.writeText(codeBlock);
            const originalText = btn.innerText;
            btn.innerText = "M√°solva!";
            setTimeout(() => btn.innerText = originalText, 1500);
            
            // Auto insert into editor if wanted?
            // editor.replaceSelection(codeBlock);
        }

        // --- 5. LOGGING & UTILS ---
        function addToOutput(text, cls="") {
            const span = document.createElement("span"); span.textContent = text;
            if(cls) span.className = cls; outputElement.appendChild(span);
            outputElement.scrollTop = outputElement.scrollHeight;
        }
        function logSystem(msg) { addToOutput("> " + msg + "\n", "system-msg"); }
        function logP2P(msg) { addToOutput("[P2P] " + msg + "\n", "p2p-msg"); }

        // --- 6. PYODIDE LOGIC ---
        let pyodide = null;
        let pyodideReady = false;
        let inputResolver = null;

        async function initPyodide() {
            try {
                pyodide = await loadPyodide();
                await pyodide.runPythonAsync(`
                    import sys, js, asyncio
                    class JSWriter:
                        def write(self, text): js.printToTerminal(text)
                        def flush(self): pass
                    sys.stdout = JSWriter(); sys.stderr = JSWriter()
                    async def custom_input(prompt=""):
                        if prompt: print(prompt, end="")
                        val = await js.waitForInput()
                        print(val); return str(val)
                `);
                pyodideReady = true;
                document.getElementById('loading-overlay').style.display = 'none';
                logSystem("Python k√∂rnyezet bet√∂ltve (v" + pyodide.version + ")");
                
                // Restore user
                const savedUser = localStorage.getItem('saved_username');
                if(savedUser) { 
                    currentUser = savedUser; 
                    document.getElementById('user-btn').innerText = savedUser; 
                }
            } catch (e) { console.error(e); logSystem("Python Hiba: " + e); }
        }
        initPyodide();

        window.printToTerminal = (text) => { addToOutput(text, ""); };
        
        // Input handling
        const termInputDiv = document.getElementById("terminal-input-bar");
        const termInput = document.getElementById("term-input");
        
        window.waitForInput = () => {
            return new Promise(resolve => {
                inputResolver = resolve;
                termInputDiv.style.display = "flex"; termInput.value = ""; termInput.focus();
                // Scroll terminal to bottom
                setTimeout(() => outputElement.scrollTop = outputElement.scrollHeight, 10);
            });
        };

        termInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && inputResolver) {
                const val = termInput.value;
                termInputDiv.style.display = "none";
                addToOutput(val + "\n", "user-input"); // Echo input
                inputResolver(val); 
                inputResolver = null;
            }
        });

        async function runPython() {
            if(!pyodideReady) return;
            const sidePanel = document.getElementById('sidePanel');
            sidePanel.classList.add('open');
            outputElement.innerHTML = ""; // Clear
            
            let code = editor.getValue();
            // Inject input wrapper
            code = code.replace(/\binput\s*\(/g, "await custom_input(");

            try {
                await pyodide.runPythonAsync(`
                    import asyncio
                    async def main_wrapper():
                        try:
${code.split('\n').map(l => '                            ' + l).join('\n')}
                        except Exception as e: print(f"Hiba: {e}")
                    await main_wrapper()
                `);
            } catch(e) { addToOutput(e.toString() + "\n", "error"); }
        }

        // --- 7. UI FUNCTIONS (SIDE PANEL) ---
        const sidePanel = document.getElementById('sidePanel');
        const trigger = document.getElementById('panel-trigger');
        let hideTimer;

        function closeSidePanel() { sidePanel.classList.remove('open'); }
        trigger.addEventListener('mouseenter', () => { 
            sidePanel.classList.add('open'); 
            if(hideTimer) clearTimeout(hideTimer);
        });
        sidePanel.addEventListener('mouseenter', () => { if(hideTimer) clearTimeout(hideTimer); });
        sidePanel.addEventListener('mouseleave', () => { 
            // Optional: Auto hide logic if wanted
            // hideTimer = setTimeout(closeSidePanel, 3000); 
        });

        // --- 8. AUTH & P2P ---
        function openLoginModal() { document.getElementById('loginModal').style.display = 'flex'; }
        function performLogin() {
            const name = document.getElementById('loginNameInput').value;
            if(name) {
                currentUser = name;
                localStorage.setItem('saved_username', name);
                document.getElementById('user-btn').innerText = name;
                document.getElementById('loginModal').style.display = 'none';
                logSystem(`Bejelentkezve mint: ${name}`);
            }
        }

        // --- 9. THEME & SETTINGS ---
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isDark = !document.body.classList.contains('light-mode');
            editor.setOption("theme", isDark ? "dracula" : "eclipse");
        }
        
        function openSettings() { document.getElementById('settingsModal').style.display='flex'; }
        function saveSettings() {
            const fs = document.getElementById('fontSizeInput').value;
            document.querySelector('.CodeMirror').style.fontSize = fs + 'px';
            document.getElementById('settingsModal').style.display='none';
            // Also update matrix
            toggleMatrix();
        }

        // --- 10. DOWNLOAD ---
        function downloadCode() {
            const blob = new Blob([editor.getValue()], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (currentUser || "program") + ".py";
            a.click();
        }

        // --- 11. GEMINI AI ---
        async function askGemini() {
            const key = document.getElementById('apiKeyInput').value;
            if(!key) { alert("Add meg a Gemini API kulcsot a be√°ll√≠t√°sokban!"); openSettings(); return; }
            logSystem("AI gondolkodik...");
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${key}`, {
                    method:"POST", headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({contents:[{parts:[{text:"Magyarul elemezd √©s jav√≠tsd:\n"+editor.getValue()}]}]})
                });
                const d = await res.json();
                addToOutput("\n[AI]: " + d.candidates[0].content.parts[0].text + "\n", "system-msg");
            } catch(e) { logSystem("AI Hiba."); }
        }

        // --- 12. P2P LOGIC (SIMPLIFIED FOR LENGTH) ---
        let peer = null;
        let conn = null;
        let isHost = false;

        document.getElementById('channel-select').addEventListener('change', function() {
            const isRandom = this.value === 'random';
            document.getElementById('custom-code-ui').style.display = isRandom ? 'block' : 'none';
            if(isRandom) {
                document.getElementById('generated-room-id').value = Math.random().toString(36).substr(2,6);
            }
        });

        function getRoomId() {
            const val = document.getElementById('channel-select').value;
            if(val === 'random') {
                return isHost ? document.getElementById('generated-room-id').value : document.getElementById('input-room-id').value;
            }
            return "ac_pro_v16_room_" + val;
        }

        function startAsHost() {
            if(!currentUser) { openLoginModal(); return; }
            if(peer) return;
            isHost = true;
            const id = getRoomId();
            logSystem(`Szoba ind√≠t√°sa: ${id}...`);
            
            peer = new Peer(id, { debug: 1 });
            peer.on('open', (id) => {
                logP2P("Szoba L√©trehozva! ID: " + id);
                document.getElementById('connect-ui').style.display='none';
                document.getElementById('disconnect-ui').style.display='block';
                updateUserList([currentUser + " (HOST)"]);
            });
            peer.on('connection', (c) => {
                c.on('data', (d) => handleData(d));
                c.on('open', () => {
                    c.send({type:'welcome', msg:"√údv a szerveren!"});
                });
            });
            peer.on('error', (err) => logP2P("Hiba: " + err.type));
        }

        function joinAsGuest() {
            if(!currentUser) { openLoginModal(); return; }
            if(peer) return;
            isHost = false;
            const id = getRoomId();
            logSystem(`Csatlakoz√°s: ${id}...`);

            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                conn.on('open', () => {
                    logP2P("Sikeres csatlakoz√°s!");
                    document.getElementById('connect-ui').style.display='none';
                    document.getElementById('disconnect-ui').style.display='block';
                    conn.send({type:'join', user:currentUser});
                });
                conn.on('data', (d) => handleData(d));
                conn.on('close', () => disconnectPeer());
            });
            peer.on('error', (err) => logP2P("Hiba: Nem tal√°lhat√≥ a szoba (" + err.type + ")"));
        }

        function handleData(data) {
            if(data.type === 'msg') {
                const chat = document.getElementById('chat-history');
                const d = document.createElement('div');
                d.style.marginBottom = "5px";
                d.style.borderBottom = "1px solid #333";
                d.innerHTML = `<strong style="color:var(--accent-color)">${data.user}:</strong> ${data.text}`;
                chat.appendChild(d);
            }
        }

        function disconnectPeer() {
            if(peer) peer.destroy();
            peer = null; conn = null;
            document.getElementById('connect-ui').style.display='block';
            document.getElementById('disconnect-ui').style.display='none';
            logP2P("Lecsatlakozva.");
        }
        
        function updateUserList(users) {
            document.getElementById('active-users-list').innerHTML = users.map(u => 
                `<div style="background:#222; padding:5px; border-radius:4px; font-size:12px; margin-bottom:2px;">${u}</div>`
            ).join('');
        }
        
        // Chat send
        const chatIn = document.getElementById('chat-input');
        chatIn.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                const txt = chatIn.value;
                if(!txt) return;
                // Local echo
                handleData({type:'msg', user:currentUser || '√ân', text:txt});
                // Send logic here if conn exists...
                chatIn.value = "";
            }
        });

    </script>
</body>
</html>
