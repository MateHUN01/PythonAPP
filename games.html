<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Arena v3 - Eyes & Smooth</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f0f13;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #00f2ff;
            --danger: #ff0055;
            --gold: #ffcc00;
        }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; height: 100vh; user-select: none; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; z-index: 10; }
        .pointer-events-auto { pointer-events: auto; }

        .panel { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); padding: 20px; border-radius: 16px; box-shadow: 0 4px 30px rgba(0,0,0,0.5); text-align: center; max-width: 350px; margin: 0 auto; transition: transform 0.2s; }
        
        h1 { font-family: 'Press Start 2P', cursive; color: var(--accent); font-size: 22px; text-shadow: 0 0 10px var(--accent); margin-bottom: 25px; line-height: 1.5;}

        input, select { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 20px; font-family: inherit; box-sizing: border-box; text-align: center; font-size: 16px; outline: none;}
        input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }
        
        button { background: var(--accent); color: #000; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: all 0.2s; font-family: 'Press Start 2P', cursive; font-size: 11px; margin-bottom: 15px; box-shadow: 0 4px 0 #00bfcc; text-transform: uppercase;}
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #00bfcc; filter: brightness(1.1); }
        button:active { transform: translateY(2px); box-shadow: 0 0 0 #00bfcc; }
        
        button.join-btn { background: #00ff44; box-shadow: 0 4px 0 #00cc36; color: #003300; }
        button.join-btn:hover { box-shadow: 0 6px 0 #00cc36; }

        canvas { display: block; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a24 0%, #000000 100%); image-rendering: pixelated; }

        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .score-board { text-align: left; font-family: 'Press Start 2P'; font-size: 10px; line-height: 1.8; min-width: 150px; }
        .game-info { text-align: center; }
        .timer { font-size: 30px; font-weight: bold; font-family: 'Press Start 2P'; color: var(--gold); text-shadow: 0 0 10px var(--gold); margin-top: 5px;}
        
        #host-controls { display: none; margin-top: 10px; }
        .color-picker { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; flex-wrap: wrap;}
        .color-btn { width: 34px; height: 34px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; position: relative;}
        .color-btn.selected { border-color: white; transform: scale(1.2); box-shadow: 0 0 15px white; z-index: 2;}

        #loading-msg { color: var(--gold); font-size: 10px; margin-top: 10px; display: none; animation: blink 1s infinite;}
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="menu-screen">
        <div class="panel pointer-events-auto">
            <h1>NEON ARENA<br><span style="font-size:12px; opacity:0.7">v3 Smooth & Cute</span></h1>
            
            <div style="margin-bottom: 10px;">
                <input type="text" id="username" placeholder="√çrd be a neved..." maxlength="12">
                <div class="color-picker" id="color-picker"></div>
            </div>

            <button onclick="attemptHost()" title="Ind√≠ts √∫j szervert">üëë HOST GAME</button>
            <button class="join-btn" onclick="attemptJoin()" title="Csatlakoz√°s a megl√©v≈ëh√∂z">üöÄ JOIN GAME</button>
            
            <div id="loading-msg">KAPCSOL√ìD√ÅS A H√ÅL√ìZATHOZ...</div>
            <div id="status-msg" style="margin-top:15px; font-size:11px; color:#ff5555; min-height:20px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="panel pointer-events-auto score-board">
                <div style="color:#888; border-bottom:1px solid #333; margin-bottom:5px; padding-bottom:5px;">TOPLISTA</div>
                <div id="score-list">...</div>
            </div>

            <div class="game-info">
                <div style="color:#aaa; font-size:10px; margin-bottom:5px; text-transform: uppercase; letter-spacing: 2px;" id="current-game-name">LOBBY</div>
                <div class="timer" id="game-timer">00:00</div>
                
                <div id="host-controls" class="panel pointer-events-auto" style="margin-top:10px; padding:10px; background: rgba(0,0,0,0.6);">
                    <select id="game-selector" style="margin-bottom:10px; font-size:12px; padding:8px;">
                        <option value="1">üî´ Tag (L√∂v√∂ld√∂z≈ës)</option>
                        <option value="2">ü™ô Coin Rush (√ârme)</option>
                        <option value="3">ü•ä Sumo (L√∂kd√∂s≈ë)</option>
                    </select>
                    <button onclick="hostStartGame()" style="font-size:10px; padding:10px; margin:0;">START ROUND</button>
                </div>
            </div>

            <div class="panel pointer-events-auto" style="min-width:100px; padding: 10px;">
                <div style="font-size:9px; color:#888; margin-bottom:5px;">STATUS</div>
                <div id="ping-display" style="font-weight:bold; color:#0f0; font-size:12px;">LOCAL</div>
            </div>
        </div>
        
        <div style="text-align:center; opacity:0.5; font-size:10px; margin-bottom: 10px;">
            MOZG√ÅS: <b>WASD / NYILAK</b> &nbsp;|&nbsp; AKCI√ì: <b>SPACE</b>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- BIZTONS√ÅGOS FIX SZOBA K√ìD (80 karakter) ---
        const FIXED_ROOM_ID = "neon-party-arena-final-v3-secure-lobby-key-do-not-change-this-string-fixed-9921";

        // --- KONFIGUR√ÅCI√ì ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const COLORS = ['#ff0055', '#00f2ff', '#00ff44', '#ffcc00', '#aa00ff', '#ffffff'];
        
        let myColor = COLORS[Math.floor(Math.random() * COLORS.length)];
        let myName = "Player" + Math.floor(Math.random()*100);
        let myId = null;
        let isHost = false;
        
        // PeerJS
        let peer, conn;
        let connections = []; // Csak hostnak

        // J√ÅT√âK √ÅLLAPOT
        // LocalPlayer: Kliens oldali sim√≠t√°s (Client-side prediction)
        let localPlayer = { x: 0, y: 0, vx: 0, vy: 0 }; 

        let gameState = {
            players: {}, 
            bullets: [],
            coins: [],
            gameMode: 0,
            timeLeft: 0,
            isPlaying: false,
            mapRadius: 0
        };

        const keys = { w:false, a:false, s:false, d:false, space:false };

        // --- SETUP ---
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(!gameState.mapRadius) gameState.mapRadius = Math.min(canvas.width, canvas.height) * 0.4;
        }
        window.addEventListener('resize', resize);
        resize();

        // UI Sz√≠nv√°laszt√≥
        const cPicker = document.getElementById('color-picker');
        COLORS.forEach(c => {
            const d = document.createElement('div');
            d.className = 'color-btn'; d.style.backgroundColor = c;
            d.onclick = () => { myColor = c; updateColorUI(); };
            if(c === myColor) d.classList.add('selected');
            cPicker.appendChild(d);
        });
        function updateColorUI() {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            const sel = Array.from(document.querySelectorAll('.color-btn')).find(b => b.style.backgroundColor === hexToRgb(myColor) || b.style.backgroundColor === myColor);
            if(sel) sel.classList.add('selected');
        }
        function hexToRgb(hex) { return hex; }

        // --- H√ÅL√ìZAT KEZEL√âS ---

        function showLoading() { document.getElementById('loading-msg').style.display='block'; }
        function hideMenu() { document.getElementById('menu-screen').style.display='none'; }
        function setStatus(msg) { document.getElementById('status-msg').innerText = msg; document.getElementById('loading-msg').style.display='none'; }

        // HOST IND√çT√ÅSA
        function attemptHost() {
            myName = document.getElementById('username').value || myName;
            showLoading();
            
            peer = new Peer(FIXED_ROOM_ID, { debug: 1 });

            peer.on('open', (id) => {
                isHost = true;
                myId = id;
                hideMenu();
                document.getElementById('host-controls').style.display = 'block';
                document.getElementById('ping-display').innerText = "HOST (SERVER)";
                
                spawnPlayer(id, myName, myColor);
                gameState.mapRadius = Math.min(canvas.width, canvas.height) * 0.4;
                gameLoop();
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    setStatus("M√ÅR VAN HOST! K√©rlek haszn√°ld a JOIN gombot.");
                } else {
                    setStatus("Hiba: " + err.type);
                }
            });

            peer.on('connection', (c) => {
                c.on('data', (data) => handleHostData(c, data));
                c.on('open', () => {
                    connections.push(c);
                    spawnPlayer(c.peer, "Guest", "#fff");
                    broadcastState();
                });
                c.on('close', () => {
                    delete gameState.players[c.peer];
                    connections = connections.filter(x => x.peer !== c.peer);
                });
            });
        }

        // CSATLAKOZ√ÅS
        function attemptJoin() {
            myName = document.getElementById('username').value || myName;
            showLoading();

            peer = new Peer(null, { debug: 1 });

            peer.on('open', (id) => {
                myId = id;
                conn = peer.connect(FIXED_ROOM_ID);

                conn.on('open', () => {
                    hideMenu();
                    document.getElementById('ping-display').innerText = "CONNECTED";
                    conn.send({ type: 'join', name: myName, color: myColor });
                    clientLoop();
                });

                conn.on('data', (data) => {
                    if (data.type === 'update') {
                        const serverMe = data.state.players[myId];
                        gameState = data.state; 
                        
                        // Anti-Lag Logic: Megtartjuk a saj√°t poz√≠ci√≥t, ha nincs nagy elt√©r√©s
                        if (serverMe && gameState.players[myId] && !serverMe.isDead) {
                            const dx = localPlayer.x - serverMe.x;
                            const dy = localPlayer.y - serverMe.y;
                            if (Math.sqrt(dx*dx + dy*dy) < 60) {
                                gameState.players[myId].x = localPlayer.x;
                                gameState.players[myId].y = localPlayer.y;
                            } else {
                                localPlayer.x = serverMe.x;
                                localPlayer.y = serverMe.y;
                            }
                        }
                    }
                });

                setTimeout(() => {
                    if(!conn.open) {
                        setStatus("NEM TAL√ÅLHAT√ì SZOBA! K√©rlek legy√©l te a HOST.");
                        document.getElementById('menu-screen').style.display='flex';
                        document.getElementById('loading-msg').style.display='none';
                    }
                }, 3000);
            });
        }

        // --- HOST LOGIKA ---

        function handleHostData(c, data) {
            if (data.type === 'join') {
                if(gameState.players[c.peer]) {
                    gameState.players[c.peer].name = data.name;
                    gameState.players[c.peer].color = data.color;
                }
            }
            if (data.type === 'move') {
                const p = gameState.players[c.peer];
                if (p && !p.isDead) {
                    p.x = data.x;
                    p.y = data.y;
                    // V√≠zszintes/F√ºgg≈ëleges sebess√©get is friss√≠tj√ºk a szem anim√°ci√≥hoz
                    p.vx = data.vx || 0;
                    p.vy = data.vy || 0;
                    
                    if(data.shoot) tryShoot(p);
                }
            }
        }

        function spawnPlayer(id, name, color) {
            gameState.players[id] = {
                id: id, x: 0, y: 0, vx: 0, vy: 0,
                color: color, name: name, score: 0, cooldown: 0, isDead: false, radius: 16
            };
        }

        function hostStartGame() {
            const mode = parseInt(document.getElementById('game-selector').value);
            gameState.gameMode = mode;
            gameState.timeLeft = 60;
            gameState.isPlaying = true;
            gameState.bullets = [];
            gameState.coins = [];
            
            const pIds = Object.keys(gameState.players);
            pIds.forEach((id, i) => {
                const p = gameState.players[id];
                p.score = 0; p.isDead = false; p.vx=0; p.vy=0;
                const angle = (i / pIds.length) * Math.PI * 2;
                const dist = gameState.mapRadius * 0.5;
                p.x = Math.cos(angle) * dist;
                p.y = Math.sin(angle) * dist;
                
                if(id === myId) { localPlayer.x = p.x; localPlayer.y = p.y; }
            });

            if (mode === 2) for(let i=0; i<25; i++) spawnCoin();
        }

        // --- FIZIKA ---

        function updateLocalPhysics() {
            const p = gameState.players[myId];
            if (!p || p.isDead) return;

            const speed = 0.8; 
            const friction = 0.90;

            if (keys.w) localPlayer.vy -= speed;
            if (keys.s) localPlayer.vy += speed;
            if (keys.a) localPlayer.vx -= speed;
            if (keys.d) localPlayer.vx += speed;

            localPlayer.x += localPlayer.vx;
            localPlayer.y += localPlayer.vy;
            localPlayer.vx *= friction;
            localPlayer.vy *= friction;

            const dist = Math.sqrt(localPlayer.x*localPlayer.x + localPlayer.y*localPlayer.y);
            const limit = gameState.mapRadius - 15; 
            if (dist > limit) {
                const angle = Math.atan2(localPlayer.y, localPlayer.x);
                localPlayer.x = Math.cos(angle) * limit;
                localPlayer.y = Math.sin(angle) * limit;
                localPlayer.vx = 0; localPlayer.vy = 0; 
            }

            p.x = localPlayer.x;
            p.y = localPlayer.y;
            p.vx = localPlayer.vx; // Fontos a szemeknek
            p.vy = localPlayer.vy;

            if (!isHost && conn && conn.open) {
                conn.send({ 
                    type: 'move', 
                    x: localPlayer.x, y: localPlayer.y,
                    vx: localPlayer.vx, vy: localPlayer.vy, // K√ºldj√ºk a sebess√©get is a szemek miatt
                    shoot: keys.space 
                });
                keys.space = false; 
            } else if (isHost) {
                 if(keys.space) { tryShoot(p); keys.space = false; }
            }
        }

        function tryShoot(p) {
            if(gameState.gameMode === 1 && p.cooldown <= 0 && gameState.isPlaying) {
                let bx = p.vx || (Math.random()-0.5); 
                let by = p.vy || (Math.random()-0.5);
                const len = Math.sqrt(bx*bx + by*by) || 1;
                bx /= len; by /= len;

                gameState.bullets.push({
                    x: p.x + bx*20, y: p.y + by*20,
                    vx: bx*12, vy: by*12, ownerId: p.id
                });
                p.cooldown = 20;
            }
        }

        function spawnCoin() {
            const a = Math.random()*6.28; const d = Math.random()*(gameState.mapRadius-30);
            gameState.coins.push({ x: Math.cos(a)*d, y: Math.sin(a)*d });
        }

        function gameLoop() {
            if (!isHost) return;
            updateLocalPhysics();

            if(gameState.isPlaying) {
                gameState.timeLeft -= 1/60;
                if(gameState.timeLeft<=0) { gameState.isPlaying=false; gameState.gameMode=0; }
            }
            Object.values(gameState.players).forEach(p => { if(p.cooldown>0) p.cooldown--; });

            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const b = gameState.bullets[i];
                b.x += b.vx; b.y += b.vy;
                if (Math.sqrt(b.x*b.x + b.y*b.y) > gameState.mapRadius) { gameState.bullets.splice(i,1); continue; }
                for(let pid in gameState.players) {
                    const p = gameState.players[pid];
                    if(p.id !== b.ownerId && !p.isDead) {
                        const dx = p.x-b.x, dy = p.y-b.y;
                        if(Math.sqrt(dx*dx+dy*dy) < p.radius+5) {
                            p.score = Math.max(0, p.score-1);
                            if(gameState.players[b.ownerId]) gameState.players[b.ownerId].score++;
                            p.x = (Math.random()-0.5)*100; p.y = (Math.random()-0.5)*100; 
                            gameState.bullets.splice(i,1);
                            break;
                        }
                    }
                }
            }
            
            if(gameState.gameMode===2) {
                Object.values(gameState.players).forEach(p => {
                    for(let i=gameState.coins.length-1; i>=0; i--) {
                        const c = gameState.coins[i];
                        if(Math.sqrt((p.x-c.x)**2 + (p.y-c.y)**2) < p.radius+10) {
                            gameState.coins.splice(i,1); p.score++; spawnCoin();
                        }
                    }
                });
            }

            broadcastState();
            render();
            updateHUD();
            requestAnimationFrame(gameLoop);
        }

        function clientLoop() {
            if(isHost) return;
            updateLocalPhysics(); 
            render();
            updateHUD();
            requestAnimationFrame(clientLoop);
        }

        function broadcastState() {
            const data = { type: 'update', state: gameState };
            connections.forEach(c => c.send(data));
        }

        window.addEventListener('keydown', e => {
            const k = e.key.toLowerCase();
            if(keys.hasOwnProperty(k) || k===' ') { if(k===' ') keys.space=true; else keys[k]=true; }
        });
        window.addEventListener('keyup', e => {
            const k = e.key.toLowerCase();
            if(keys.hasOwnProperty(k) || k===' ') { if(k===' ') keys.space=false; else keys[k]=false; }
        });

        // --- RENDER (SZEMEK VISSZAT√âRTEK) ---
        function render() {
            ctx.fillStyle = '#0f0f13'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(canvas.width/2, canvas.height/2);

            // P√°lya
            ctx.beginPath(); ctx.arc(0,0, gameState.mapRadius, 0, 6.28);
            ctx.fillStyle = '#14141c'; ctx.fill();
            ctx.lineWidth=5; 
            ctx.strokeStyle = gameState.gameMode===1?'#ff0055':gameState.gameMode===2?'#ffcc00':gameState.gameMode===3?'#00f2ff':'#333';
            ctx.stroke();

            // R√°cs
            ctx.strokeStyle = 'rgba(255,255,255,0.03)'; ctx.lineWidth=1;
            for(let i=-gameState.mapRadius; i<gameState.mapRadius; i+=50) {
                ctx.beginPath(); ctx.moveTo(i,-gameState.mapRadius); ctx.lineTo(i,gameState.mapRadius); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-gameState.mapRadius,i); ctx.lineTo(gameState.mapRadius,i); ctx.stroke();
            }

            // Objektumok
            gameState.coins.forEach(c => {
                ctx.beginPath(); ctx.arc(c.x, c.y, 8, 0, 6.28); ctx.fillStyle='#ffcc00'; ctx.fill();
                ctx.shadowBlur=10; ctx.shadowColor='#ffcc00'; ctx.fill(); ctx.shadowBlur=0;
            });
            gameState.bullets.forEach(b => {
                ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, 6.28); ctx.fillStyle='#ff0055'; ctx.fill();
            });

            // J√ÅT√âKOSOK (SZEMES VERZI√ì)
            Object.values(gameState.players).forEach(p => {
                if(p.isDead) return;

                // 1. Test
                ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, 6.28);
                ctx.fillStyle = p.color; ctx.fill();
                // Glow effekt
                ctx.shadowBlur=15; ctx.shadowColor=p.color; ctx.fill(); ctx.shadowBlur=0;

                // 2. Szemek (Ir√°ny a sebess√©gb≈ël)
                // Ha nagyon kicsi a sebess√©g, akkor el≈ëre n√©zzenek (vagy az utols√≥ ir√°nyba)
                // Itt egy tr√ºkk: megszorozzuk a sebess√©get, hogy a szemek elmozduljanak
                let lookX = (p.vx || 0) * 3;
                let lookY = (p.vy || 0) * 3;
                
                // Limit√°ljuk, hogy ne essenek le az arcr√≥l
                const maxLook = 6;
                if(lookX > maxLook) lookX = maxLook; if(lookX < -maxLook) lookX = -maxLook;
                if(lookY > maxLook) lookY = maxLook; if(lookY < -maxLook) lookY = -maxLook;

                // Feh√©r r√©sz
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(p.x - 5 + lookX, p.y - 4 + lookY, 5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(p.x + 5 + lookX, p.y - 4 + lookY, 5, 0, Math.PI*2); ctx.fill();
                
                // Fekete pupilla
                ctx.fillStyle = 'black';
                ctx.beginPath(); ctx.arc(p.x - 5 + lookX*1.2, p.y - 4 + lookY*1.2, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(p.x + 5 + lookX*1.2, p.y - 4 + lookY*1.2, 2, 0, Math.PI*2); ctx.fill();
                
                // N√©v
                ctx.fillStyle='#fff'; ctx.font="bold 10px Roboto"; ctx.textAlign="center";
                ctx.fillText(p.name, p.x, p.y-25);
            });

            ctx.restore();
        }

        function updateHUD() {
            const m = Math.floor(gameState.timeLeft/60);
            const s = Math.floor(gameState.timeLeft%60).toString().padStart(2,'0');
            document.getElementById('game-timer').innerText = `${m}:${s}`;
            const modes = ["LOBBY", "TAG", "COIN", "SUMO"];
            document.getElementById('current-game-name').innerText = modes[gameState.gameMode];

            const list = Object.values(gameState.players).sort((a,b)=>b.score-a.score);
            document.getElementById('score-list').innerHTML = list.map(p=>`<div style="display:flex; justify-content:space-between; color:${p.color}; font-weight:bold;"><span>${p.name}</span><span>${p.score}</span></div>`).join('');
        }

    </script>
</body>
</html>
