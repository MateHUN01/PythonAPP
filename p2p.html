<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC P2P Diagnosztika</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: monospace; background: #121214; color: #e0e0e0; padding: 20px; max-width: 800px; margin: auto; }
        .box { border: 1px solid #333; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #1e1e1e; }
        h2 { margin-top: 0; color: #2196F3; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        input, button { padding: 10px; border-radius: 4px; border: 1px solid #444; background: #2c2c2c; color: white; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; background: #2196F3; border: none; }
        button:hover { background: #1976D2; }
        button.disconnect { background: #ff5555; }

        .log-window { height: 200px; overflow-y: scroll; background: #000; border: 1px solid #333; padding: 10px; font-size: 12px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-error { color: #ff5555; }
        .log-success { color: #50fa7b; }
        .log-info { color: #8be9fd; }

        #my-id-display { font-size: 24px; font-weight: bold; color: #50fa7b; text-align: center; word-break: break-all; margin: 10px 0; user-select: all; cursor: pointer; border: 2px dashed #444; padding: 10px; }
        
        .status-dot { height: 10px; width: 10px; background-color: #ff5555; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #50fa7b; }
    </style>
</head>
<body>

    <h1>üì° P2P Kapcsolat Teszter</h1>
    <p style="color:#888;">Ez az oldal csak a PeerJS kapcsolatot teszteli, minden m√°s n√©lk√ºl.</p>

    <div class="box">
        <h2>1. √ân (Azonos√≠t√≥)</h2>
        <div id="connection-status"><span class="status-dot" id="status-dot"></span> <span id="status-text">Csatlakoz√°s a PeerServerhez...</span></div>
        
        <div style="font-size:12px; color:#888; text-align:center; margin-top:10px;">A Te K√≥dod (Kattints a m√°sol√°shoz):</div>
        <div id="my-id-display" onclick="copyId()" title="Kattints a m√°sol√°shoz">GENER√ÅL√ÅS...</div>
        <div style="text-align:center; font-size:11px; color:orange;">Ha ez "GENER√ÅL√ÅS..." marad, akkor a h√°l√≥zatod blokkolja a kapcsolatot.</div>
    </div>

    <div class="box">
        <h2>2. Csatlakoz√°s M√ÅSHOZ</h2>
        <input type="text" id="remote-id" placeholder="Illeszd be a partner k√≥dj√°t ide...">
        <button onclick="connectToPartner()">Kapcsol√≥d√°s</button>
        <button onclick="disconnect()" class="disconnect" style="display:none;" id="btn-disconnect">Sz√©tkapcsol√°s</button>
    </div>

    <div class="box">
        <h2>3. Adatk√ºld√©s Teszt</h2>
        <input type="text" id="msg-input" placeholder="√çrj √ºzenetet..." disabled>
        <button onclick="sendMessage()" id="btn-send" disabled>K√ºld√©s</button>
    </div>

    <div class="box">
        <h2>Rendszer Napl√≥</h2>
        <div class="log-window" id="logs"></div>
    </div>

    <script>
        let peer = null;
        let conn = null;

        // Napl√≥z√≥ seg√©df√ºggv√©ny
        function log(msg, type="info") {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toLocaleTimeString();
            entry.innerText = `[${time}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(msg);
        }

        // 1. Peer inicializ√°l√°sa (Indul√°skor azonnal)
        function init() {
            log("PeerJS ind√≠t√°sa...", "info");
            
            // Konfigur√°ci√≥: Google STUN szervereit haszn√°ljuk a t≈±zfalak √°tt√∂r√©s√©hez
            peer = new Peer(null, {
                debug: 2,
                config: {
                    'iceServers': [
                        { url: 'stun:stun.l.google.com:19302' },
                        { url: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            // SIKERES NYIT√ÅS (Ha kapunk ID-t a felh≈ëb≈ël)
            peer.on('open', (id) => {
                document.getElementById('my-id-display').innerText = id;
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-text').innerText = "Online - K√©szen √°llsz!";
                log(`Sikeres szerver kapcsolat! A k√≥dod: ${id}`, "success");
            });

            // HA M√ÅS CSATLAKOZIK HOZZ√ÅNK
            peer.on('connection', (connection) => {
                log("Valaki csatlakozni pr√≥b√°l hozz√°d...", "info");
                setupConnection(connection);
            });

            // HIBAKEZEL√âS (Ez a legfontosabb r√©sz neked most)
            peer.on('error', (err) => {
                document.getElementById('status-text').innerText = "HIBA T√ñRT√âNT";
                document.getElementById('my-id-display').innerText = "HIBA";
                document.getElementById('my-id-display').style.color = "red";
                
                let errorMsg = err.type;
                if(err.type === 'browser-incompatible') errorMsg = "A b√∂ng√©sz≈ëd nem t√°mogatja a WebRTC-t.";
                if(err.type === 'network') errorMsg = "H√°l√≥zati hiba / T≈±zfal blokkol√°s.";
                if(err.type === 'peer-unavailable') errorMsg = "A megadott ID nem l√©tezik vagy nem el√©rhet≈ë.";
                
                log(`HIBA: ${errorMsg} (${err})`, "error");
            });

            peer.on('disconnected', () => {
                log("Megszakadt a kapcsolat a szerverrel. √öjracsatlakoz√°s...", "error");
                peer.reconnect();
            });
        }

        // 2. Csatlakoz√°s kezdem√©nyez√©se
        function connectToPartner() {
            const remoteId = document.getElementById('remote-id').value.trim();
            if(!remoteId) {
                log("K√©rlek add meg a partner ID-j√°t!", "error");
                return;
            }
            if(remoteId === peer.id) {
                log("Magadhoz nem csatlakozhatsz!", "error");
                return;
            }

            log(`Csatlakoz√°s ehhez: ${remoteId}...`, "info");
            const connection = peer.connect(remoteId);
            setupConnection(connection);
        }

        // 3. Kapcsolat be√°ll√≠t√°sa (K√∂z√∂s f√ºggv√©ny a h√≠v√≥nak √©s h√≠vottnak)
        function setupConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                log("P2P KAPCSOLAT L√âTREJ√ñTT! üü¢", "success");
                
                // UI friss√≠t√©se
                document.getElementById('msg-input').disabled = false;
                document.getElementById('btn-send').disabled = false;
                document.getElementById('btn-disconnect').style.display = 'inline-block';
                
                // √údv√∂zl≈ë adat k√ºld√©se
                conn.send("Szia! Sikeresen kapcsol√≥dtam.");
            });

            conn.on('data', (data) => {
                log(`Bej√∂v≈ë √ºzenet: ${data}`, "info");
            });

            conn.on('close', () => {
                log("A partner lecsatlakozott.", "error");
                resetUI();
            });

            conn.on('error', (err) => {
                log(`Kapcsolati hiba: ${err}`, "error");
            });
        }

        // √úzenet k√ºld√©se
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const msg = input.value;
            if(conn && conn.open && msg) {
                conn.send(msg);
                log(`Elk√ºldve: ${msg}`, "info");
                input.value = "";
            } else {
                log("Nincs akt√≠v kapcsolat!", "error");
            }
        }

        // Sz√©tkapcsol√°s
        function disconnect() {
            if(conn) conn.close();
            resetUI();
            log("Sz√©tkapcsolva.", "info");
        }

        function resetUI() {
            conn = null;
            document.getElementById('msg-input').disabled = true;
            document.getElementById('btn-send').disabled = true;
            document.getElementById('btn-disconnect').style.display = 'none';
        }

        function copyId() {
            const text = document.getElementById('my-id-display').innerText;
            if(text !== "GENER√ÅL√ÅS..." && text !== "HIBA") {
                navigator.clipboard.writeText(text);
                log("ID m√°solva a v√°g√≥lapra.", "success");
            }
        }

        // Ind√≠t√°s
        init();

    </script>
</body>
</html>